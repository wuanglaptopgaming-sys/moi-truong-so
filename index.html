<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>M√¥i Tr∆∞·ªùng S·ªë H·ªçc T·∫≠p</title>
<style>
  :root{
    --accent:#0072ff; --accent-2:#00c6ff; --muted:#6b7280;
    --bg:#f9fafb; --card:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#1f2937}
  header{
    background:var(--card);
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 28px;border-bottom:1px solid #e6eef8;position:sticky;top:0;z-index:30;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{
    width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:700;background:linear-gradient(135deg,var(--accent-2),var(--accent))
  }
  .brand .title{line-height:1}
  .brand .title h1{margin:0;font-size:17px}
  .brand .title p{margin:0;font-size:12px;color:var(--muted)}
  nav{display:flex;align-items:center;gap:10px}
  nav a, nav button{font-weight:600;background:transparent;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;color:#1f2937;text-decoration:none}
  nav a:hover, nav button:hover{background:#f1f5f9}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-primary:hover{background:#005bd1}

  /* Main intro */
  .intro-section {
    width:100%; background: linear-gradient(135deg,#eef5ff,#ffffff);
    padding:48px 60px; display:flex; gap:36px; align-items:center; box-sizing:border-box;
  }
  .intro-text{flex:1}
  .intro-text h1{font-size:36px;color:#1a73e8;margin:0 0 8px}
  .intro-text p{color:#444;line-height:1.7;margin:0 0 16px}

  .intro-image{flex:1;display:flex;align-items:center;justify-content:center}
  .intro-image img{width:100%;max-width:520px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.08);transform-origin:center;animation:fadeZoomIn 1s ease}
  @keyframes fadeZoomIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}

  /* Lower columns */
  .columns{display:flex;gap:28px;padding:36px 60px;box-sizing:border-box}
  .card{background:#fff;border-radius:14px;padding:20px;box-shadow:0 6px 18px rgba(2,6,23,0.06);flex:1}
  .card h3{margin:0 0 12px;font-size:18px}

  /* Sidebar user panel (off-canvas) */
  #userPanel {
    position: fixed; top: 0; right: -380px; width: 380px; height: 100%; background: var(--card);
    border-left: 1px solid #e6eef8; box-shadow: -8px 0 30px rgba(2,6,23,0.08); transition: right .28s ease; z-index:60;
    display:flex;flex-direction:column;
  }
  #userPanel.open { right: 0; }
  #userPanel header{background:var(--accent);color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
  #userPanel header button{background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer}
  .user-info{padding:16px;overflow-y:auto;flex:1}
  .user-info label{display:block;margin-top:10px;font-weight:700;color:#233}
  .user-info input[type="text"], .user-info input[type="email"], .user-info textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8}
  .save-btn{margin-top:12px;background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}

  /* avatar */
  .avatar-area{text-align:center;margin-bottom:8px}
  .avatar-area img{width:110px;height:110px;border-radius:50%;object-fit:cover;border:4px solid transparent;background:linear-gradient(white,white) padding-box, linear-gradient(135deg,#6ce0ff,#5d74ff) border-box}
  .avatar-area .small-note{font-size:13px;color:var(--muted);margin-top:6px}

  /* friend section */
  .friend-section{padding:12px;border-top:1px solid #eef5ff}
  .friend-actions{display:flex;gap:8px;align-items:center}
  .friend-actions input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8}
  .friend-actions button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .friend-list{margin-top:12px}
  .friend-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:#f8fafc;margin-bottom:8px}
  .friend-item img{width:40px;height:40px;border-radius:50%;object-fit:cover}
  .invite-row{display:flex;justify-content:space-between;align-items:center;padding:8px;margin-bottom:8px;border-radius:8px;background:#f8fafc}

  /* small responsive */
  @media(max-width:880px){ .intro-section{flex-direction:column;padding:28px} .columns{flex-direction:column;padding:24px} #userPanel{width:100%;} }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ED</div>
    <div class="title">
      <h1>M√¥i Tr∆∞·ªùng S·ªë H·ªçc T·∫≠p</h1>
      <p>H·ªçc ‚Äî Chia s·∫ª ‚Äî K·∫øt n·ªëi</p>
    </div>
  </div>

  <nav id="nav">
    <a href="community.html">C·ªông ƒë·ªìng</a>
<a href="groups.html">Nh√≥m h·ªçc t·∫≠p</a>

    <button id="btn-signup">ƒêƒÉng k√Ω</button>
    <button id="btn-login" class="btn-primary">ƒêƒÉng nh·∫≠p</button>
  </nav>
</header>

<!-- Intro -->
<main class="intro-section">
  <div class="intro-text">
    <h1>üéì M√¥i Tr∆∞·ªùng S·ªë H·ªçc T·∫≠p</h1>
    <p>Kh√¥ng gian d√†nh cho sinh vi√™n ƒë·ªÉ chia s·∫ª b√†i t·∫≠p, h·ªèi ƒë√°p, k·∫øt n·ªëi v√† c√πng nhau ti·∫øn b·ªô. Tham gia c·ªông ƒë·ªìng, ƒëƒÉng b√†i v√† k·∫øt b·∫°n ngay!</p>
    <div style="margin-top:18px">
      <a href="community.html" style="text-decoration:none"><button style="padding:10px 18px;border-radius:30px;border:0;background:var(--accent);color:#fff;cursor:pointer">V√†o c·ªông ƒë·ªìng</button></a>
    </div>
  </div>
  <div class="intro-image">
    <img src="https://cdn0986.cdn4s.com/media/2021/01/truong_hoc_truc_tuyen.jpg" alt="H·ªçc t·∫≠p">
  </div>
</main>


<!-- User Panel (off-canvas right) -->
<div id="userPanel" aria-hidden="true">
  <header>
    <span>Th√¥ng tin ng∆∞·ªùi d√πng</span>
    <button id="closeUserPanel" aria-label="ƒê√≥ng">&times;</button>
  </header>

  <div class="user-info">
    <div class="avatar-area">
      <img id="avatarPreview" alt="Avatar">
      <div class="small-note">·∫¢nh ƒë·∫°i di·ªán</div>
      <input id="infoAvatar" type="file" accept="image/*" style="display:none">
      <div style="margin-top:8px">
        <button id="changeAvatarBtn" style="padding:8px 10px;border-radius:8px;border:0;background:#eee;cursor:pointer">ƒê·ªïi ·∫£nh</button>
      </div>
    </div>

    <label>T√™n ng∆∞·ªùi d√πng</label>
    <input id="infoName" type="text" disabled>

    <label>ID</label>
    <input id="infoID" type="text" disabled>

    <label>Ng√†y sinh</label>
    <input id="infoDOB" type="date">

    <label>Email</label>
    <input id="infoEmail" type="email" placeholder="you@example.com">

    <label>M√¥ t·∫£</label>
    <textarea id="infoDesc" placeholder="Gi·ªõi thi·ªáu v·ªÅ b·∫£n th√¢n..."></textarea>

    <button id="saveUserInfo" class="save-btn">L∆∞u th√¥ng tin</button>

    <div class="friend-section">
      <h4 style="margin:0 0 8px">K·∫øt b·∫°n</h4>
      <div class="friend-actions">
        <input id="friendSearchSidebar" placeholder="T√¨m theo t√™n ho·∫∑c ID...">
        <button id="friendSearchBtn">T√¨m</button>
        <button id="friendMailBtn" title="H·ªôp th∆∞ l·ªùi m·ªùi" style="width:40px;border-radius:8px;background:var(--accent);color:#fff;border:0">üì©</button>
      </div>

      <div id="friendInvites" style="display:none;margin-top:10px">
        <!-- invites inserted here -->
      </div>

      <div class="friend-list" id="friendListArea" style="margin-top:10px">
        <!-- friends inserted here -->
      </div>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="modalLogin" style="display:none" aria-hidden="true">
  <div class="modal-backdrop" role="dialog" aria-modal="true" style="position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:70">
    <div class="modal" role="document" style="width:100%;max-width:420px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 12px 40px rgba(2,6,23,0.2)">
      <h3>ƒêƒÉng nh·∫≠p</h3>
      <div class="form-group"><label for="loginUser">T√™n ƒëƒÉng nh·∫≠p</label><input id="loginUser" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p"></div>
      <div class="form-group"><label for="loginPass">M·∫≠t kh·∫©u</label><input id="loginPass" type="password" placeholder="M·∫≠t kh·∫©u"></div>
      <div id="loginError" style="color:#b91c1c;display:none;margin-top:8px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="link" id="toSignupFromLogin">Ch∆∞a c√≥ t√†i kho·∫£n?</button>
        <button id="closeLogin" class="link">H·ªßy</button>
        <button id="submitLogin" class="btn-primary">ƒêƒÉng nh·∫≠p</button>
      </div>
    </div>
  </div>
</div>

<!-- Signup Modal -->
<div id="modalSignup" style="display:none" aria-hidden="true">
  <div class="modal-backdrop" role="dialog" aria-modal="true" style="position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:70">
    <div class="modal" role="document" style="width:100%;max-width:420px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 12px 40px rgba(2,6,23,0.2)">
      <h3>ƒêƒÉng k√Ω</h3>
      <div class="form-group"><label for="signupUser">T√™n ƒëƒÉng nh·∫≠p</label><input id="signupUser" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p"></div>
      <div class="form-group"><label for="signupPass">M·∫≠t kh·∫©u</label><input id="signupPass" type="password" placeholder="M·∫≠t kh·∫©u (8-16 k√Ω t·ª±)"></div>
      <div id="signupError" style="color:#b91c1c;display:none;margin-top:8px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="link" id="toLoginFromSignup">ƒê√£ c√≥ t√†i kho·∫£n?</button>
        <button id="closeSignup" class="link">H·ªßy</button>
        <button id="submitSignup" class="btn-primary">ƒêƒÉng k√Ω</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Helpers & storage ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

function getUsers(){ return JSON.parse(localStorage.getItem('users')||'[]'); }
function saveUsers(arr){ localStorage.setItem('users', JSON.stringify(arr)); }

function getInvites(){ return JSON.parse(localStorage.getItem('invites')||'[]'); }
function saveInvites(arr){ localStorage.setItem('invites', JSON.stringify(arr)); }

/* default cat avatar */
const DEFAULT_AVATAR = 'https://i.imgur.com/6VBx3io.png'; // cute cat

/* ---------- Elements ---------- */
const navEl = document.getElementById('nav');
const btnLogin = document.getElementById('btn-login');
const btnSignup = document.getElementById('btn-signup');
const modalLogin = document.getElementById('modalLogin');
const modalSignup = document.getElementById('modalSignup');
const closeLogin = document.getElementById('closeLogin');
const closeSignup = document.getElementById('closeSignup');

const userPanel = document.getElementById('userPanel');
const closeUserPanel = document.getElementById('closeUserPanel');
const avatarPreview = document.getElementById('avatarPreview');
const infoAvatarInput = document.getElementById('infoAvatar');
const changeAvatarBtn = document.getElementById('changeAvatarBtn');
const saveUserInfoBtn = document.getElementById('saveUserInfo');

const infoName = document.getElementById('infoName');
const infoID = document.getElementById('infoID');
const infoDOB = document.getElementById('infoDOB');
const infoEmail = document.getElementById('infoEmail');
const infoDesc = document.getElementById('infoDesc');

const friendSearchSidebar = document.getElementById('friendSearchSidebar');
const friendSearchBtn = document.getElementById('friendSearchBtn');
const friendInvitesBox = document.getElementById('friendInvites');
const friendListArea = document.getElementById('friendListArea');
const friendMailBtn = document.getElementById('friendMailBtn');

/* modal form fields */
const signupUser = document.getElementById('signupUser');
const signupPass = document.getElementById('signupPass');
const signupError = document.getElementById('signupError');
const submitSignup = document.getElementById('submitSignup');

const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const loginError = document.getElementById('loginError');
const submitLogin = document.getElementById('submitLogin');

/* ---------- UI behavior ---------- */
// open panels
changeAvatarBtn.addEventListener('click', ()=> infoAvatarInput.click());
closeUserPanel.addEventListener('click', ()=> userPanel.classList.remove('open'));

// open login/signup
btnLogin.addEventListener('click', ()=> { modalLogin.style.display='block'; modalSignup.style.display='none'; loginError.style.display='none'; });
btnSignup.addEventListener('click', ()=> { modalSignup.style.display='block'; modalLogin.style.display='none'; signupError.style.display='none'; });
closeLogin.addEventListener('click', ()=> modalLogin.style.display='none');
closeSignup.addEventListener('click', ()=> modalSignup.style.display='none');
document.getElementById('toSignupFromLogin').addEventListener('click', ()=> { modalLogin.style.display='none'; modalSignup.style.display='block'; });
document.getElementById('toLoginFromSignup').addEventListener('click', ()=> { modalSignup.style.display='none'; modalLogin.style.display='block'; });

/* ---------- Signup / Login ---------- */
function genUserId(users){
  // generate id like #1001 incrementally
  const base = 1000 + users.length + 1;
  return '#'+base;
}

submitSignup.addEventListener('click', ()=>{
  signupError.style.display='none';
  const u = signupUser.value.trim();
  const p = signupPass.value;
  if(!u || !p){ signupError.textContent='Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin.'; signupError.style.display='block'; return; }
  if(p.length < 8 || p.length > 16){ signupError.textContent='M·∫≠t kh·∫©u ph·∫£i c√≥ t·ª´ 8 ƒë·∫øn 16 k√Ω t·ª±.'; signupError.style.display='block'; return; }
  const users = getUsers();
  if(users.find(x=>x.username.toLowerCase() === u.toLowerCase())){ signupError.textContent='T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i.'; signupError.style.display='block'; return; }
  const newUser = { username: u, password: p, id: genUserId(users), avatar: null, dob:'', email:'', desc:'', friends: [] };
  users.push(newUser);
  saveUsers(users);
  localStorage.setItem('username', u);
  modalSignup.style.display='none';
  renderNav(); // show logged in state
  showUserInfo(); // open panel with info
});

submitLogin.addEventListener('click', ()=>{
  loginError.style.display='none';
  const u = loginUser.value.trim();
  const p = loginPass.value;
  if(!u || !p){ loginError.textContent='Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin.'; loginError.style.display='block'; return; }
  const users = getUsers();
  const found = users.find(x=>x.username === u && x.password === p);
  if(!found){ loginError.textContent='Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u.'; loginError.style.display='block'; return; }
  localStorage.setItem('username', u);
  modalLogin.style.display='none';
  renderNav();
});

/* ---------- Navigation ---------- */
function renderNav(){
  const username = localStorage.getItem('username');
  if(!username){ resetNav(); return; }
  const users = getUsers();
  const me = users.find(u=>u.username === username);
  const avatar = (me && me.avatar) ? me.avatar : DEFAULT_AVATAR;
  navEl.innerHTML = `
    <a href="community.html">C·ªông ƒë·ªìng</a>
    <a href="groups.html">Nh√≥m h·ªçc t·∫≠p</a>
    <img id="navAvatar" src="${avatar}" alt="avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;cursor:pointer;margin-left:6px">
    <span style="margin-left:8px">Xin ch√†o, <strong id="nav-user">${username}</strong></span>
    <button id="logoutBtn" class="link" style="margin-left:8px">ƒêƒÉng xu·∫•t</button>
  `;
  $('#logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem('username');
    renderNav();
  });
  $('#navAvatar').addEventListener('click', ()=>{ userPanel.classList.add('open'); showUserInfo(); });
  document.getElementById('nav-user').addEventListener('click', ()=>{ userPanel.classList.add('open'); showUserInfo(); });
}

function renderNav(){
  const username = localStorage.getItem('username');
  if(!username){ resetNav(); return; }
  const users = getUsers();
  const me = users.find(u=>u.username === username);
  const avatar = (me && me.avatar) ? me.avatar : DEFAULT_AVATAR;
  navEl.innerHTML = `
    <a href="community.html">C·ªông ƒë·ªìng</a>
    <img id="navAvatar" src="${avatar}" alt="avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;cursor:pointer;margin-left:6px">
    <span style="margin-left:8px">Xin ch√†o, <strong id="nav-user">${username}</strong></span>
    <button id="logoutBtn" class="link" style="margin-left:8px">ƒêƒÉng xu·∫•t</button>
  `;
  $('#logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem('username');
    renderNav();
  });
  // open user panel when click avatar/name
  $('#navAvatar').addEventListener('click', ()=>{ userPanel.classList.add('open'); showUserInfo(); });
  document.getElementById('nav-user').addEventListener('click', ()=>{ userPanel.classList.add('open'); showUserInfo(); });
}

/* ---------- User Panel logic ---------- */
function showUserInfo(){
  const username = localStorage.getItem('username');
  const users = getUsers();
  // fill
  if(!username){
    // show default placeholders
    avatarPreview.src = DEFAULT_AVATAR;
    infoName.value = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
    infoID.value = '·∫®n';
    infoDOB.value = '';
    infoEmail.value = '';
    infoDesc.value = '';
    // disable edit except avatar change blocked
    infoDOB.disabled = true; infoEmail.disabled = true; infoDesc.disabled = true; changeAvatarBtn.disabled = true;
    friendListArea.innerHTML = '<div style="color:var(--muted)">B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</div>';
    friendInvitesBox.style.display='none';
    return;
  }
  const me = users.find(u=>u.username === username);
  if(!me){
    avatarPreview.src = DEFAULT_AVATAR;
    return;
  }
  avatarPreview.src = me.avatar || DEFAULT_AVATAR;
  infoName.value = me.username;
  infoID.value = me.id;
  infoDOB.value = me.dob || '';
  infoEmail.value = me.email || '';
  infoDesc.value = me.desc || '';
  infoDOB.disabled = false; infoEmail.disabled = false; infoDesc.disabled = false; changeAvatarBtn.disabled = false;

  // render friends (me.friends)
  renderFriendsForUser(me);
  // render invites addressed to me
  renderInvitesForUser(me.username);
}

changeAvatarBtn.addEventListener('click', ()=> infoAvatarInput.click());
infoAvatarInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const data = ev.target.result;
    avatarPreview.src = data;
    // save to current user object
    const username = localStorage.getItem('username');
    if(!username) return;
    const users = getUsers();
    const me = users.find(u=>u.username===username);
    if(!me) return;
    me.avatar = data;
    saveUsers(users);
    renderNav();
  }
  reader.readAsDataURL(f);
});

/* Save user info */
saveUserInfoBtn.addEventListener('click', ()=>{
  const username = localStorage.getItem('username');
  if(!username){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u th√¥ng tin'); return; }
  const users = getUsers();
  const me = users.find(u=>u.username === username);
  if(!me) return;
  me.dob = infoDOB.value;
  me.email = infoEmail.value.trim();
  me.desc = infoDesc.value.trim();
  saveUsers(users);
  alert('ƒê√£ l∆∞u th√¥ng tin c√° nh√¢n');
  renderNav();
});

/* ---------- Friends / Invites logic ---------- */
/* invites stored globally as array of {to, fromName, fromId, fromAvatar} */
function renderInvitesForUser(username){
  const invites = getInvites().filter(i=>i.to === username);
  if(!invites.length){
    friendInvitesBox.innerHTML = '<div style="color:var(--muted)">üì≠ H·ªôp th∆∞ tr·ªëng</div>';
    friendInvitesBox.style.display='block';
    return;
  }
  friendInvitesBox.style.display='block';
  friendInvitesBox.innerHTML = '';
  invites.forEach((inv, idx)=>{
    const row = document.createElement('div');
    row.className = 'invite-row';
    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px">
        <img src="${inv.fromAvatar||DEFAULT_AVATAR}" style="width:40px;height:40px;border-radius:50%;object-fit:cover">
        <div><strong>${inv.fromName}</strong><div style="font-size:13px;color:var(--muted)">${inv.fromId||''}</div></div>
      </div>
      <div>
        <button class="accept-btn" data-idx="${idx}" style="margin-right:8px;padding:6px 8px;border-radius:6px;border:0;background:#10b981;color:#fff">[+]</button>
        <button class="reject-btn" data-idx="${idx}" style="padding:6px 8px;border-radius:6px;border:0;background:#ef4444;color:#fff">X√≥a</button>
      </div>
    `;
    friendInvitesBox.appendChild(row);
  });

  // bind accept/reject
  friendInvitesBox.querySelectorAll('.accept-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const idx = parseInt(e.target.getAttribute('data-idx'));
      let invites = getInvites();
      // find the actual invite index among filtered invites
      const allInvites = getInvites();
      const filtered = allInvites.filter(i=>i.to === localStorage.getItem('username'));
      const inv = filtered[idx];
      // remove the first matching invite (match on unique combination)
      const removeIndex = allInvites.findIndex(x=> x.to===inv.to && x.fromName===inv.fromName && x.fromId===inv.fromId);
      if(removeIndex > -1) allInvites.splice(removeIndex,1);
      saveInvites(allInvites);
  const users = getUsers();
const currentUser = users.find(u => u.username === localStorage.getItem('username'));
const otherUser = users.find(u => u.username === inv.fromName);

if(currentUser && otherUser){
  // th√™m b·∫°n v√†o m√¨nh
  if(!currentUser.friends) currentUser.friends = [];
  if(!currentUser.friends.find(f => f.name === otherUser.username)){
    currentUser.friends.push({ 
      name: otherUser.username,
      id: otherUser.id,
      avatar: otherUser.avatar || DEFAULT_AVATAR
    });
  }

  // th√™m b·∫°n v√†o ng∆∞·ªùi kia
  if(!otherUser.friends) otherUser.friends = [];
  if(!otherUser.friends.find(f => f.name === currentUser.username)){
    otherUser.friends.push({
      name: currentUser.username,
      id: currentUser.id,
      avatar: currentUser.avatar || DEFAULT_AVATAR
    });
  }

  saveUsers(users);
}

renderInvitesForUser(currentUser.username);
renderFriendsForUser(currentUser);
renderNav();

    });
  });

  friendInvitesBox.querySelectorAll('.reject-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const idx = parseInt(e.target.getAttribute('data-idx'));
      const all = getInvites();
      const filtered = all.filter(i=>i.to === localStorage.getItem('username'));
      const inv = filtered[idx];
      const removeIndex = all.findIndex(x=> x.to===inv.to && x.fromName===inv.fromName && x.fromId===inv.fromId);
      if(removeIndex > -1) all.splice(removeIndex,1);
      saveInvites(all);
      renderInvitesForUser(localStorage.getItem('username'));
    });
  });
}

/* render friends list for given user object */
function renderFriendsForUser(userObj){
  friendListArea.innerHTML = '';
  const arr = userObj.friends || [];
  if(!arr.length){
    friendListArea.innerHTML = '<div style="color:var(--muted)">Ch∆∞a c√≥ b·∫°n b√® n√†o.</div>';
    return;
  }
  arr.forEach(f=>{
    const el = document.createElement('div');
    el.className = 'friend-item';
    el.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><img src="${f.avatar||DEFAULT_AVATAR}"><div><strong>${f.name}</strong><div style="font-size:13px;color:var(--muted)">${f.id||''}</div></div></div><div><button class="unfriend" data-name="${f.name}" style="border:0;background:#ef4444;color:#fff;padding:6px 8px;border-radius:6px">‚ùå</button></div>`;
    friendListArea.appendChild(el);
  });

  // bind unfriend
  friendListArea.querySelectorAll('.unfriend').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const name = e.target.getAttribute('data-name');
      const users = getUsers();
      const me = users.find(u=>u.username === localStorage.getItem('username'));
      if(!me) return;
      me.friends = (me.friends||[]).filter(x=> x.name !== name);
      saveUsers(users);
      renderFriendsForUser(me);
    });
  });
}

/* ---------- Search (fix: cannot find self) ---------- */
friendSearchBtn.addEventListener('click', ()=>{
  const keyword = (friendSearchSidebar.value||'').trim();
  if(!keyword) return alert('Nh·∫≠p t√™n ho·∫∑c ID ƒë·ªÉ t√¨m');
  const users = getUsers();
  const current = localStorage.getItem('username') || null;
  const found = users.find(u => (u.username.toLowerCase() === keyword.toLowerCase() || (u.id && u.id.toLowerCase() === keyword.toLowerCase())) && u.username !== current);
  if(!found){
    alert('Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i ho·∫∑c b·∫°n ƒëang t√¨m ch√≠nh b·∫°n.');
    return;
  }
  // show mini card with option send invite
  showFoundUserMini(found);
});

function showFoundUserMini(user){
  // small modal-like card inserted into friendInvitesBox temporarily
  const box = friendInvitesBox;
  box.style.display='block';
  box.innerHTML = `<div class="invite-row">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="${user.avatar||DEFAULT_AVATAR}" style="width:48px;height:48px;border-radius:50%;object-fit:cover">
      <div><strong>${user.username}</strong><div style="font-size:13px;color:var(--muted)">${user.id}</div></div>
    </div>
    <div>
      <button id="sendInviteBtn" style="padding:6px 8px;border-radius:6px;border:0;background:#1a73e8;color:#fff">G·ª≠i l·ªùi m·ªùi</button>
    </div>
  </div>`;
document.getElementById('sendInviteBtn').addEventListener('click', ()=>{
  const current = localStorage.getItem('username') || null;
  if(!current) return alert('B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p ƒë·ªÉ k·∫øt b·∫°n.');

  const users = getUsers();
  const me = users.find(u=>u.username===current);
  if(!me) return;

  // ‚úÖ 1) Kh√¥ng g·ª≠i l·ªùi m·ªùi cho ng∆∞·ªùi ƒë√£ l√† b·∫°n
  if(me.friends && me.friends.some(f => f.name === user.username)){
    return alert('Ng∆∞·ªùi n√†y ƒë√£ l√† b·∫°n b√® c·ªßa b·∫°n.');
  }

  let invites = getInvites();

  // ‚úÖ 2) Kh√¥ng g·ª≠i tr√πng l·ªùi m·ªùi
  if(invites.some(i => i.to === user.username && i.fromName === current)){
    return alert('B·∫°n ƒë√£ g·ª≠i l·ªùi m·ªùi cho ng∆∞·ªùi n√†y r·ªìi.');
  }

  // ‚úÖ 3) T·∫°o l·ªùi m·ªùi m·ªõi
  invites.push({
    to: user.username,
    fromName: current,
    fromId: me.id,
    fromAvatar: me.avatar || DEFAULT_AVATAR
  });

  saveInvites(invites);
  alert('ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n.');
});

}

/* ---------- Init ---------- */
function init(){
  // render nav based on login
  renderNav();

  // bind click outside to close panel
  document.addEventListener('click', (e)=>{
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(b=>{
      // nothing here
    });
  });

  // show sidebar placeholder when not logged in
  // attach mail button toggle
  friendMailBtn.addEventListener('click', ()=>{
    const u = localStorage.getItem('username');
    if(!u){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem h·ªôp th∆∞.'); return; }
    // toggle invites box
    friendInvitesBox.style.display = friendInvitesBox.style.display === 'block' ? 'none' : 'block';
    renderInvitesForUser(u);
  });

  // if logged in open panel automatically? no ‚Äî keep manual
}
init();

</script>
</body>
</html>
