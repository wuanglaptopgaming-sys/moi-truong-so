<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>M√¥i Tr∆∞·ªùng S·ªë H·ªçc T·∫≠p - Fix B·∫°n B√®</title>
<style>
  :root{
    --accent:#0072ff; --accent-2:#00c6ff; --muted:#6b7280;
    --bg:#f9fafb; --card:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#1f2937}
  header{
    background:var(--card);
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 28px;border-bottom:1px solid #e6eef8;position:sticky;top:0;z-index:30;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{
    width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:700;background:linear-gradient(135deg,var(--accent-2),var(--accent))
  }
  .brand .title{line-height:1}
  .brand .title h1{margin:0;font-size:17px}
  .brand .title p{margin:0;font-size:12px;color:var(--muted)}
  nav{display:flex;align-items:center;gap:10px}
  nav a, nav button{font-weight:600;background:transparent;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;color:#1f2937;text-decoration:none}
  nav a:hover, nav button:hover{background:#f1f5f9}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-primary:hover{background:#005bd1}

  .intro-section{width:100%;background:linear-gradient(135deg,#eef5ff,#ffffff);padding:48px 60px;display:flex;gap:36px;align-items:center}
  .intro-text{flex:1}
  .intro-text h1{font-size:36px;color:#1a73e8;margin:0 0 8px}
  .intro-text p{color:#444;line-height:1.7;margin:0 0 16px}
  .intro-image{flex:1;display:flex;align-items:center;justify-content:center}
  .intro-image img{width:100%;max-width:520px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.08)}

   /* Sidebar user panel (off-canvas) */
  #userPanel {
    position: fixed; top: 0; right: -380px; width: 380px; height: 100%; background: var(--card);
    border-left: 1px solid #e6eef8; box-shadow: -8px 0 30px rgba(2,6,23,0.08); transition: right .28s ease; z-index:60;
    display:flex;flex-direction:column;
  }
  #userPanel.open { right: 0; }
  #userPanel header{background:var(--accent);color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
  #userPanel header button{background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer}
  .user-info{padding:16px;overflow-y:auto;flex:1}
  .user-info label{display:block;margin-top:10px;font-weight:700;color:#233}
  .user-info input[type="text"], .user-info input[type="email"], .user-info textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8}
  .save-btn{margin-top:12px;background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}

  /* avatar */
  .avatar-area{text-align:center;margin-bottom:8px}
  .avatar-area img{width:110px;height:110px;border-radius:50%;object-fit:cover;border:4px solid transparent;background:linear-gradient(white,white) padding-box, linear-gradient(135deg,#6ce0ff,#5d74ff) border-box}
  .avatar-area .small-note{font-size:13px;color:var(--muted);margin-top:6px}

  /* friend section */
  .friend-section{padding:12px;border-top:1px solid #eef5ff}
  .friend-actions{display:flex;gap:8px;align-items:center}
  .friend-actions input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8}
  .friend-actions button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .friend-list{margin-top:12px}
  .friend-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:#f8fafc;margin-bottom:8px}
  .friend-item img{width:40px;height:40px;border-radius:50%;object-fit:cover}
  .invite-row{display:flex;justify-content:space-between;align-items:center;padding:8px;margin-bottom:8px;border-radius:8px;background:#fff;border:1px solid #eef5ff}

  .badge{font-size:12px;background:#f1f5f9;padding:4px 8px;border-radius:999px;color:#334155;margin-left:8px}

  /* small responsive */
  @media(max-width:880px){ .intro-section{flex-direction:column;padding:28px} .columns{flex-direction:column;padding:24px} #userPanel{width:100%;} }

</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ED</div>
    <div class="title">
      <h1>M√¥i Tr∆∞·ªùng S·ªë H·ªçc T·∫≠p</h1>
      <p>H·ªçc ‚Äî Chia s·∫ª ‚Äî K·∫øt n·ªëi</p>
    </div>
  </div>
  <nav id="nav">
    <a href="community.html">C·ªông ƒë·ªìng</a>
    <a href="groups.html">Nh√≥m h·ªçc t·∫≠p</a>
    <button id="btn-signup">ƒêƒÉng k√Ω</button>
    <button id="btn-login" class="btn-primary">ƒêƒÉng nh·∫≠p</button>
  </nav>
</header>

<main class="intro-section">
  <div class="intro-text">
    <h1>üéì M√¥i Tr∆∞·ªùng S·ªë H·ªçc T·∫≠p</h1>
    <p>Kh√¥ng gian d√†nh cho sinh vi√™n ƒë·ªÉ chia s·∫ª b√†i t·∫≠p, h·ªèi ƒë√°p, k·∫øt n·ªëi v√† c√πng nhau ti·∫øn b·ªô.</p>
    <a href="community.html"><button style="padding:10px 18px;border-radius:30px;border:0;background:var(--accent);color:#fff">V√†o c·ªông ƒë·ªìng</button></a>
  </div>
  <div class="intro-image"><img src="https://cdn0986.cdn4s.com/media/2021/01/truong_hoc_truc_tuyen.jpg" alt=""></div>
</main>

<!-- B·∫£ng th√¥ng tin ng∆∞·ªùi d√πng -->
<div id="userPanel" aria-hidden="true">
  <header>
    <span>Th√¥ng tin ng∆∞·ªùi d√πng</span>
    <button id="closeUserPanel" aria-label="ƒê√≥ng">&times;</button>
  </header>

  <div class="user-info">
    <div class="avatar-area">
      <img id="avatarPreview" alt="Avatar">
      <div class="small-note">·∫¢nh ƒë·∫°i di·ªán</div>
      <input id="infoAvatar" type="file" accept="image/*" style="display:none">
      <div style="margin-top:8px">
        <button id="changeAvatarBtn" style="padding:8px 10px;border-radius:8px;border:0;background:#eee;cursor:pointer">ƒê·ªïi ·∫£nh</button>
      </div>
    </div>

    <label>T√™n ng∆∞·ªùi d√πng</label>
    <input id="infoName" type="text" disabled>

    <label>ID</label>
    <input id="infoID" type="text" disabled>

    <label>Ng√†y sinh</label>
    <input id="infoDOB" type="date">

    <label>Email</label>
    <input id="infoEmail" type="email" placeholder="you@example.com">

    <label>M√¥ t·∫£</label>
    <textarea id="infoDesc" placeholder="Gi·ªõi thi·ªáu v·ªÅ b·∫£n th√¢n..."></textarea>

    <button id="saveUserInfo" class="save-btn">L∆∞u th√¥ng tin</button>

    <div class="friend-section">
      <h4 style="margin:0 0 8px">K·∫øt b·∫°n <span id="pendingBadge" class="badge" style="display:none"></span></h4>
      <div class="friend-actions">
        <input id="friendSearchSidebar" placeholder="T√¨m theo t√™n ho·∫∑c ID...">
        <button id="friendSearchBtn">T√¨m</button>
        <button id="friendMailBtn" title="H·ªôp th∆∞ l·ªùi m·ªùi" style="width:40px;border-radius:8px;background:var(--accent);color:#fff;border:0">üì©</button>
      </div>

      <div id="friendInvites" style="display:none;margin-top:10px">
        <!-- invites inserted here -->
      </div>

      <div class="friend-list" id="friendListArea" style="margin-top:10px">
        <!-- friends inserted here -->
      </div>
    </div>
  </div>
</div>

<!-- Modal ƒëƒÉng nh·∫≠p / ƒëƒÉng k√Ω -->
<div id="modalLogin" style="display:none">
  <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center">
    <div style="background:white;padding:20px;border-radius:10px;max-width:400px;width:100%">
      <h3>ƒêƒÉng nh·∫≠p</h3>
      <input id="loginUser" placeholder="T√™n ƒëƒÉng nh·∫≠p"><br>
      <input id="loginPass" type="password" placeholder="M·∫≠t kh·∫©u"><br>
      <div id="loginError" style="color:red;display:none"></div>
      <button id="submitLogin">ƒêƒÉng nh·∫≠p</button>
      <button id="toSignupFromLogin">Ch∆∞a c√≥ t√†i kho·∫£n?</button>
      <button id="closeLogin">ƒê√≥ng</button>
    </div>
  </div>
</div>

<div id="modalSignup" style="display:none">
  <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center">
    <div style="background:white;padding:20px;border-radius:10px;max-width:400px;width:100%">
      <h3>ƒêƒÉng k√Ω</h3>
      <input id="signupUser" placeholder="T√™n ƒëƒÉng nh·∫≠p"><br>
      <input id="signupPass" type="password" placeholder="M·∫≠t kh·∫©u"><br>
      <div id="signupError" style="color:red;display:none"></div>
      <button id="submitSignup">ƒêƒÉng k√Ω</button>
      <button id="toLoginFromSignup">ƒê√£ c√≥ t√†i kho·∫£n?</button>
      <button id="closeSignup">ƒê√≥ng</button>
    </div>
  </div>
</div>

<script>
const $ = s=>document.querySelector(s);
const $$ = sel => document.querySelectorAll(sel);

function getUsers(){ return JSON.parse(localStorage.getItem('users')||'[]'); }
function saveUsers(arr){ localStorage.setItem('users', JSON.stringify(arr)); }

function getInvites(){ return JSON.parse(localStorage.getItem('invites')||'[]'); }
function saveInvites(arr){ localStorage.setItem('invites', JSON.stringify(arr)); }

const DEFAULT_AVATAR='https://i.imgur.com/6VBx3io.png';
const navEl=document.getElementById('nav');

/* --- Seed small demo users when none exist (helps testing) --- */
(function seedIfEmpty(){
  const u=getUsers();
  if(u.length===0){
    u.push({username:'alice',password:'password123',id:'#1001',avatar:'',dob:'1999-01-01',email:'alice@example.com',desc:'Sinh vi√™n l·ªõp 1',friends:[]});
    u.push({username:'bob',password:'password123',id:'#1002',avatar:'',dob:'2000-02-02',email:'bob@example.com',desc:'Sinh vi√™n l·ªõp 2',friends:[]});
    saveUsers(u);
  }
})();

function resetNav(){
  navEl.innerHTML=`
    <a href="community.html">C·ªông ƒë·ªìng</a>
    <a href="groups.html">Nh√≥m h·ªçc t·∫≠p</a>
    <button id="btn-signup">ƒêƒÉng k√Ω</button>
    <button id="btn-login" class="btn-primary">ƒêƒÉng nh·∫≠p</button>`;
  $('#btn-login').onclick=()=>modalLogin.style.display='block';
  $('#btn-signup').onclick=()=>modalSignup.style.display='block';
}

function renderNav(){
  const u=localStorage.getItem('username');
  if(!u){resetNav();updatePendingBadge();return;}
  const users=getUsers(); const me=users.find(x=>x.username===u);
  const av=(me&&me.avatar)?me.avatar:DEFAULT_AVATAR;
  navEl.innerHTML=`
    <a href="community.html">C·ªông ƒë·ªìng</a>
    <a href="groups.html">Nh√≥m h·ªçc t·∫≠p</a>
    <img id="navAvatar" src="${av}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;cursor:pointer">
    <span>Xin ch√†o, <strong id="nav-user">${u}</strong></span>
    <button id="logoutBtn">ƒêƒÉng xu·∫•t</button>`;
  $('#logoutBtn').onclick=()=>{localStorage.removeItem('username');renderNav();};
  $('#navAvatar').onclick=()=>{userPanel.classList.add('open');showUserInfo();renderAllFriendUI();};
  $('#nav-user').onclick=()=>{userPanel.classList.add('open');showUserInfo();renderAllFriendUI();};
  updatePendingBadge();
}

const modalLogin=$('#modalLogin'),modalSignup=$('#modalSignup');
$('#closeLogin').onclick=()=>modalLogin.style.display='none';
$('#closeSignup').onclick=()=>modalSignup.style.display='none';
$('#toSignupFromLogin').onclick=()=>{modalLogin.style.display='none';modalSignup.style.display='block';};
$('#toLoginFromSignup').onclick=()=>{modalSignup.style.display='none';modalLogin.style.display='block';};

$('#submitSignup').onclick=()=>{
  const u=$('#signupUser').value.trim(),p=$('#signupPass').value;
  const err=$('#signupError');
  err.style.display='none'; err.textContent='';
  if(!u||!p){err.textContent='ƒêi·ªÅn ƒë·ªß th√¥ng tin';err.style.display='block';return;}
  if(p.length<8||p.length>16){err.textContent='M·∫≠t kh·∫©u 8-16 k√Ω t·ª±';err.style.display='block';return;}
  const arr=getUsers();
  if(arr.some(x=>x.username.toLowerCase()===u.toLowerCase())){err.textContent='T√™n ƒë√£ t·ªìn t·∫°i';err.style.display='block';return;}
  arr.push({username:u,password:p,id:'#'+(1000+arr.length+1),avatar:null,dob:'',email:'',desc:'',friends:[]});
  saveUsers(arr);localStorage.setItem('username',u);modalSignup.style.display='none';renderNav();
};

$('#submitLogin').onclick=()=>{
  const u=$('#loginUser').value.trim(),p=$('#loginPass').value;const err=$('#loginError');
  err.style.display='none'; err.textContent='';
  const arr=getUsers();const f=arr.find(x=>x.username===u&&x.password===p);
  if(!f){err.textContent='Sai th√¥ng tin';err.style.display='block';return;}
  localStorage.setItem('username',u);modalLogin.style.display='none';renderNav();
};

/* user panel info */
const userPanel=$('#userPanel');$('#closeUserPanel').onclick=()=>userPanel.classList.remove('open');
function showUserInfo(){
  const u=localStorage.getItem('username');const arr=getUsers();const me=arr.find(x=>x.username===u);
  $('#avatarPreview').src=(me&&me.avatar)||DEFAULT_AVATAR;
  $('#infoName').value=me?me.username:'Ch∆∞a ƒëƒÉng nh·∫≠p';
  $('#infoID').value=me?me.id:'·∫®n';
  $('#infoDOB').value=me?me.dob:'';$('#infoEmail').value=me?me.email:'';$('#infoDesc').value=me?me.desc:'';
}
$('#changeAvatarBtn').onclick=()=>$('#infoAvatar').click();
$('#infoAvatar').onchange=e=>{
  const f=e.target.files[0];if(!f)return;const r=new FileReader();
  r.onload=v=>{
    const u=localStorage.getItem('username');const arr=getUsers();const me=arr.find(x=>x.username===u);
    if(me){me.avatar=v.target.result;saveUsers(arr);renderNav();$('#avatarPreview').src=v.target.result;}
  };r.readAsDataURL(f);
};
$('#saveUserInfo').onclick=()=>{
  const u=localStorage.getItem('username');const arr=getUsers();const me=arr.find(x=>x.username===u);
  if(me){me.dob=$('#infoDOB').value;me.email=$('#infoEmail').value;me.desc=$('#infoDesc').value;saveUsers(arr);alert('ƒê√£ l∆∞u!');}
};

/* --- Friend system --- */

// Utility: render pending badge (number of incoming invites)
function updatePendingBadge(){
  const u=localStorage.getItem('username');
  if(!u){$('#pendingBadge').style.display='none';return;}
  const invites=getInvites();
  const count=invites.filter(iv=>iv.to===u).length;
  const badge=$('#pendingBadge');
  if(count>0){badge.style.display='inline-block';badge.textContent= count + ' ch·ªù';}
  else badge.style.display='none';
}

// Render friend list (friends stored as array of usernames)
function renderFriendList(){
  const area=$('#friendListArea'); area.innerHTML='';
  const u=localStorage.getItem('username'); if(!u){area.innerHTML='<div style="color:var(--muted)">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem b·∫°n b√®</div>';return;}
  const users=getUsers(); const me=users.find(x=>x.username===u);
  if(!me || !me.friends || me.friends.length===0){ area.innerHTML='<div style="color:var(--muted)">B·∫°n ch∆∞a c√≥ b·∫°n b√®.</div>'; return; }
  me.friends.forEach(fname=>{
    const friend = users.find(x=>x.username===fname);
    const av = (friend && friend.avatar) ? friend.avatar : DEFAULT_AVATAR;
    const div=document.createElement('div'); div.className='friend-item';
    div.innerHTML = `<img src="${av}" alt=""><div style="flex:1"><strong>${fname}</strong><div style="font-size:12px;color:var(--muted)">${friend?friend.email:''}</div></div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn-unfriend" data-name="${fname}" style="padding:6px;border-radius:8px;border:1px solid #eee;background:#fff;cursor:pointer">H·ªßy k·∫øt b·∫°n</button>
      </div>`;
    area.appendChild(div);
  });
  // attach unfriend handlers
  $$('.btn-unfriend').forEach(b=>b.onclick=()=>{
    const name=b.getAttribute('data-name'); if(!confirm('H·ªßy k·∫øt b·∫°n v·ªõi '+name+'?'))return;
    const usersArr=getUsers();
    const me2=usersArr.find(x=>x.username===localStorage.getItem('username'));
    const other=usersArr.find(x=>x.username===name);
    if(me2){ me2.friends = me2.friends.filter(x=>x!==name); }
    if(other){ other.friends = other.friends.filter(x=>x!==me2.username); }
    saveUsers(usersArr); renderFriendList(); renderNav(); alert('ƒê√£ h·ªßy k·∫øt b·∫°n.');
  });
}

// Render search results when user searches for friend
function renderSearchResults(query){
  const q = (query||'').trim().toLowerCase();
  const area=$('#friendListArea'); area.innerHTML='';
  const u=localStorage.getItem('username'); if(!u){area.innerHTML='<div style="color:var(--muted)">ƒêƒÉng nh·∫≠p ƒë·ªÉ t√¨m b·∫°n</div>';return;}
  if(!q){ renderFriendList(); return; }
  const users=getUsers(); const me=users.find(x=>x.username===u);
  // filter users: match name or id, exclude self and existing friends, show those who haven't been invited yet
  const invites=getInvites();
  const results = users.filter(x=> (x.username.toLowerCase().includes(q) || x.id.toLowerCase().includes(q)) && x.username!==u );
  if(results.length===0){ area.innerHTML='<div style="color:var(--muted)">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>'; return; }
  results.forEach(user=>{
    const alreadyFriend = me && me.friends && me.friends.includes(user.username);
    const sentInvite = invites.some(iv=>iv.from===u && iv.to===user.username);
    const receivedInvite = invites.some(iv=>iv.from===user.username && iv.to===u);
    const av=(user.avatar)?user.avatar:DEFAULT_AVATAR;
    const row=document.createElement('div'); row.className='invite-row';
    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${av}" style="width:46px;height:46px;border-radius:50%"><div><strong>${user.username}</strong><div style="font-size:12px;color:var(--muted)">${user.id}</div></div></div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">` +
      (alreadyFriend? `<div style="color:var(--muted)">ƒê√£ l√† b·∫°n</div>` :
       receivedInvite? `<div style="color:var(--muted)">ƒê√£ nh·∫≠n l·ªùi m·ªùi t·ª´ h·ªç</div>` :
       sentInvite? `<div style="color:var(--muted)">ƒê√£ g·ª≠i l·ªùi m·ªùi</div>` :
       `<button class="btn-send-invite" data-name="${user.username}" style="padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer">G·ª≠i l·ªùi m·ªùi</button>`
      ) + `</div>`;
    area.appendChild(row);
  });
  $$('.btn-send-invite').forEach(b=>b.onclick=()=>{ sendInvite(b.getAttribute('data-name')); });
}

// Send invite (creates invite that must be accepted)
function sendInvite(toUsername){
  const from=localStorage.getItem('username'); if(!from){alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i l·ªùi m·ªùi');return;}
  if(from===toUsername){alert('Kh√¥ng th·ªÉ g·ª≠i l·ªùi m·ªùi t·ªõi ch√≠nh b·∫°n');return;}
  const users=getUsers(); const me=users.find(x=>x.username===from);
  if(me && me.friends && me.friends.includes(toUsername)){alert('ƒê√£ l√† b·∫°n');return;}
  const invites=getInvites();
  if(invites.some(iv=>iv.from===from && iv.to===toUsername)){alert('B·∫°n ƒë√£ g·ª≠i l·ªùi m·ªùi tr∆∞·ªõc ƒë√≥');return;}
  if(invites.some(iv=>iv.from===toUsername && iv.to===from)){alert('Ng∆∞·ªùi kia ƒë√£ g·ª≠i l·ªùi m·ªùi cho b·∫°n ‚Äî ki·ªÉm tra h·ªôp th∆∞');return;}
  invites.push({id:'inv'+(Date.now()),from:from,to:toUsername,ts:new Date().toISOString()});
  saveInvites(invites); alert('ƒê√£ g·ª≠i l·ªùi m·ªùi! Ng∆∞·ªùi nh·∫≠n s·∫Ω ph·∫£i ch·∫•p nh·∫≠n.'); renderAllFriendUI(); updatePendingBadge();
}

// Render invites area (both incoming and outgoing)
function renderInvitesArea(){
  const area=$('#friendInvites'); area.innerHTML=''; area.style.display='block';
  const u=localStorage.getItem('username'); if(!u){area.innerHTML='<div style="color:var(--muted)">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem l·ªùi m·ªùi</div>';return;}
  const invites=getInvites(); const users=getUsers();

  const incoming = invites.filter(iv=>iv.to===u);
  const outgoing = invites.filter(iv=>iv.from===u);

  const incDiv=document.createElement('div'); incDiv.innerHTML='<h4>L·ªùi m·ªùi ƒë·∫øn b·∫°n</h4>';
  if(incoming.length===0) incDiv.innerHTML += '<div style="color:var(--muted)">Kh√¥ng c√≥ l·ªùi m·ªùi ƒë·∫øn</div>';
  incoming.forEach(iv=>{
    const fromUser = users.find(x=>x.username===iv.from) || {};
    const av=fromUser.avatar||DEFAULT_AVATAR;
    const row=document.createElement('div'); row.className='invite-row';
    row.innerHTML=`<div style="display:flex;gap:10px;align-items:center"><img src="${av}" style="width:46px;height:46px;border-radius:50%"><div><strong>${iv.from}</strong><div style="font-size:12px;color:var(--muted)">${fromUser.id||''}</div></div></div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn-accept" data-id="${iv.id}" style="padding:8px 10px;border-radius:8px;border:0;background:#10b981;color:#fff;cursor:pointer">Ch·∫•p nh·∫≠n</button>
        <button class="btn-decline" data-id="${iv.id}" style="padding:8px 10px;border-radius:8px;border:1px solid #eee;background:#fff;cursor:pointer">T·ª´ ch·ªëi</button>
      </div>`;
    incDiv.appendChild(row);
  });

  const outDiv=document.createElement('div'); outDiv.style.marginTop='12px'; outDiv.innerHTML='<h4>L·ªùi m·ªùi b·∫°n ƒë√£ g·ª≠i</h4>';
  if(outgoing.length===0) outDiv.innerHTML += '<div style="color:var(--muted)">B·∫°n ch∆∞a g·ª≠i l·ªùi m·ªùi n√†o</div>';
  outgoing.forEach(iv=>{
    const toUser = users.find(x=>x.username===iv.to) || {};
    const av=toUser.avatar||DEFAULT_AVATAR;
    const row=document.createElement('div'); row.className='invite-row';
    row.innerHTML=`<div style="display:flex;gap:10px;align-items:center"><img src="${av}" style="width:46px;height:46px;border-radius:50%"><div><strong>${iv.to}</strong><div style="font-size:12px;color:var(--muted)">${toUser.id||''}</div></div></div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn-cancel" data-id="${iv.id}" style="padding:8px 10px;border-radius:8px;border:1px solid #eee;background:#fff;cursor:pointer">H·ªßy</button>
      </div>`;
    outDiv.appendChild(row);
  });

  area.appendChild(incDiv); area.appendChild(outDiv);

  $$('.btn-accept').forEach(b=>b.onclick=()=>acceptInvite(b.getAttribute('data-id')));
  $$('.btn-decline').forEach(b=>b.onclick=()=>declineInvite(b.getAttribute('data-id')));
  $$('.btn-cancel').forEach(b=>b.onclick=()=>cancelOutgoingInvite(b.getAttribute('data-id')));
}

// Accept invite: update both users' friends arrays, remove invite
function acceptInvite(invId){
  const invites=getInvites(); const iv=invites.find(x=>x.id===invId); if(!iv) return;
  const users=getUsers();
  const me=users.find(x=>x.username===iv.to);
  const other=users.find(x=>x.username===iv.from);
  if(me && other){
    me.friends = Array.from(new Set([...(me.friends||[]), other.username]));
    other.friends = Array.from(new Set([...(other.friends||[]), me.username]));
    saveUsers(users);
  }
  // remove invite
  const newInv=invites.filter(x=>x.id!==invId); saveInvites(newInv);
  renderAllFriendUI(); alert('ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi.'); updatePendingBadge();
}

// Decline invite: just remove invite
function declineInvite(invId){
  if(!confirm('T·ª´ ch·ªëi l·ªùi m·ªùi n√†y?')) return;
  const invites=getInvites(); const newInv=invites.filter(x=>x.id!==invId); saveInvites(newInv);
  renderAllFriendUI(); updatePendingBadge();
}

// Cancel outgoing invite
function cancelOutgoingInvite(invId){
  if(!confirm('H·ªßy l·ªùi m·ªùi b·∫°n ƒë√£ g·ª≠i?')) return;
  const invites=getInvites(); const newInv=invites.filter(x=>x.id!==invId); saveInvites(newInv);
  renderAllFriendUI(); updatePendingBadge();
}

// Render everything related to friends (list + invites badge)
function renderAllFriendUI(){
  renderFriendList(); renderInvitesArea(); updatePendingBadge();
}

/* Event bindings for friend UI */
$('#friendSearchBtn').onclick=()=>{ renderSearchResults($('#friendSearchSidebar').value); };
$('#friendSearchSidebar').addEventListener('keydown', e=>{ if(e.key==='Enter') renderSearchResults($('#friendSearchSidebar').value); });

$('#friendMailBtn').onclick=()=>{
  const el=$('#friendInvites');
  el.style.display = (el.style.display==='block') ? 'none' : 'block';
  if(el.style.display==='block') renderInvitesArea();
};

// When user opens panel, update friend UI
userPanel.addEventListener('transitionend', ()=>{ if(userPanel.classList.contains('open')) renderAllFriendUI(); });

/* init */
function init(){ renderNav(); }
init();

</script>
</body>
</html>
