<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C·ªông ƒë·ªìng h·ªçc t·∫≠p</title>
<style>
:root{
  --accent:#0072ff;
  --bg:#f5f8ff;
  --card:#fff;
  --text:#222;
  --muted:#6b7280;
}
body{
  font-family: "Segoe UI", sans-serif;
  margin:0;padding:0;
  background:var(--bg);color:var(--text);
}
header{
  background:var(--card);
  padding:12px 24px;
  display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid #dbe3f4;position:sticky;top:0;z-index:20;
}
header .brand{display:flex;align-items:center;gap:12px;}
.logo{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#00c6ff,#0072ff);color:white;font-weight:700;}
header nav a{margin-left:14px;font-weight:600;text-decoration:none;color:var(--text);}
header nav a:hover{color:var(--accent);}
.post-box{
  background:var(--card);max-width:600px;margin:20px auto;padding:18px;border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.07);
}
.post-box textarea{
  width:100%;border:none;resize:none;padding:10px;border-radius:8px;background:#f0f4ff;
}
.post-box input[type=file]{display:none;}
.post-box label{
  display:inline-block;margin-top:8px;padding:6px 12px;background:var(--accent);
  color:white;border-radius:6px;cursor:pointer;
}
.post-box button{
  margin-top:10px;padding:8px 16px;background:var(--accent);color:white;
  border:none;border-radius:8px;cursor:pointer;
}
.post{
  background:var(--card);max-width:600px;margin:14px auto;padding:16px;border-radius:12px;
  box-shadow:0 1px 6px rgba(0,0,0,0.06);
}
.post-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.avatar{width:45px;height:45px;border-radius:50%;object-fit:cover;}
.avatar-small{width:28px;height:28px;border-radius:50%;object-fit:cover;}
.post-img,.comment-img{max-width:100%;border-radius:12px;margin-top:8px;cursor:pointer;display:block;}
.post-img{max-height:280px;object-fit:cover;}
.post-actions{margin-top:6px;display:flex;gap:12px;}
.post-actions button{background:transparent;border:none;color:var(--accent);cursor:pointer;}
.comment-box{margin-top:10px;border-top:1px solid #eee;padding-top:10px;}
.comment{display:flex;gap:8px;margin-top:10px;}
.comment-content{background:#f3f6ff;border-radius:10px;padding:6px 10px;flex:1;}
.comment-img{max-width:150px;border-radius:8px;display:block;margin-top:6px;}
.delete-post,.delete-cmt{border:none;background:none;color:red;cursor:pointer;}
.like-cmt{border:none;background:none;cursor:pointer;margin-top:4px;}
#imgView{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;}
#imgView img{max-width:90%;max-height:90%;border-radius:12px;}
.file-link{display:block;margin-top:8px;color:var(--accent);text-decoration:none;}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ED</div>
    <strong>C·ªông ƒë·ªìng h·ªçc t·∫≠p</strong>
  </div>
  <nav>
    <a href="index.html">Trang ch·ªß</a>
  </nav>
</header>

<div class="post-box">
  <textarea id="postText" placeholder="B·∫°n ƒëang nghƒ© g√¨?"></textarea>
  <label for="postImg">üìé Th√™m t·ªáp</label>
  <input type="file" id="postImg" multiple accept="image/*,video/*,application/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.rar,.txt">
  <button id="postBtn">ƒêƒÉng b√†i</button>
</div>

<div id="postList"></div>

<div id="imgView"><img></div>

<script>
const DEFAULT_AVATAR = "https://i.imgur.com/PHv4T6B.png";

function getUsers(){return JSON.parse(localStorage.getItem("users")||"[]");}
function getPosts(){return JSON.parse(localStorage.getItem("posts")||"[]");}
function savePosts(p){localStorage.setItem("posts",JSON.stringify(p));}
function getInvites(){return JSON.parse(localStorage.getItem("invites")||"[]");}
function saveInvites(p){localStorage.setItem("invites",JSON.stringify(p));}
function now(){return new Date().toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"});}
function getCurrentUser(){
  const name=localStorage.getItem("username");
  if(!name)return null;
  return getUsers().find(u=>u.username===name)||null;
}

/* Utility: read multiple files to data URLs, callback receives array of {name,type,data} */
function readFilesToData(files, cb){
  const arr = Array.from(files || []);
  if(arr.length === 0){ cb([]); return; }
  const out = [];
  let done = 0;
  arr.forEach(file=>{
    const reader = new FileReader();
    reader.onload = e=>{
      out.push({name: file.name, type: file.type || 'application/octet-stream', data: e.target.result});
      done++;
      if(done === arr.length) cb(out);
    };
    reader.onerror = ()=>{
      // still count as done (skip file)
      done++;
      if(done === arr.length) cb(out);
    };
    reader.readAsDataURL(file);
  });
}

/* ====== ƒêƒÉng b√†i (h·ªó tr·ª£ nhi·ªÅu t·ªáp) ====== */
document.getElementById("postBtn").onclick = function(){
  const user = getCurrentUser();
  if(!user){ alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!"); return; }
  const text = document.getElementById("postText").value.trim();
  const files = document.getElementById("postImg").files;
  if(!text && (!files || files.length === 0)) return;

  readFilesToData(files, function(fileData){
    const posts = getPosts();
    // keep backward-compatible: if no files and only legacy img expected, we still store files: []
    posts.unshift({
      user: user.username,
      avatar: user.avatar || DEFAULT_AVATAR,
      text: text,
      files: fileData.length ? fileData : (text && posts.length>0 && false) ? [] : [], // store array (possibly empty)
      // Note: older posts might have p.img string; we keep compatibility in render()
      time: now(),
      likes: [],
      comments: []
    });
    savePosts(posts);
    document.getElementById("postText").value = "";
    document.getElementById("postImg").value = "";
    render();
  });
};

/* ====== Render posts (supports legacy p.img and new p.files) ====== */
function render(){
  const posts = getPosts();
  const container = document.getElementById("postList");
  container.innerHTML = "";
  const me = getCurrentUser();
  posts.forEach((p,i)=>{
    // outer post element
    const postEl = document.createElement("div");
    postEl.className = "post";

    // header
    const header = document.createElement("div");
    header.className = "post-header";
    const avatar = document.createElement("img");
    avatar.className = "avatar";
    avatar.src = p.avatar || DEFAULT_AVATAR;
    avatar.onclick = ()=> showUserPopup(p.user);
    header.appendChild(avatar);

    const userBox = document.createElement("div");
    userBox.innerHTML = `<b>${p.user}</b><div class="post-time">${p.time}</div>`;
    header.appendChild(userBox);

    const delBtn = document.createElement("button");
    delBtn.className = "delete-post";
    delBtn.textContent = "üóëÔ∏è";
    delBtn.onclick = ()=> deletePost(i);
    header.appendChild(delBtn);

    postEl.appendChild(header);

    // text
    const ptext = document.createElement("p");
    ptext.innerHTML = p.text || "";
    postEl.appendChild(ptext);

    // files area (support legacy p.img string OR new p.files array)
    const filesArea = document.createElement("div");
    // Legacy single image (old data)
    if(p.img && typeof p.img === 'string' && p.img.length){
      const imgEl = document.createElement("img");
      imgEl.className = "post-img";
      imgEl.src = p.img;
      imgEl.onclick = ()=> viewImg(p.img);
      filesArea.appendChild(imgEl);
    }
    // New files array
    if(Array.isArray(p.files) && p.files.length){
      p.files.forEach(f=>{
        if(f && f.type && f.type.startsWith("image/")){
          const imgEl = document.createElement("img");
          imgEl.className = "post-img";
          imgEl.src = f.data;
          imgEl.onclick = ()=> viewImg(f.data);
          filesArea.appendChild(imgEl);
        } else if(f && f.type && f.type.startsWith("video/")){
          const v = document.createElement("video");
          v.className = "post-img";
          v.src = f.data;
          v.controls = true; // play on click by user
          filesArea.appendChild(v);
        } else if (f && f.data){
          const a = document.createElement("a");
          a.className = "file-link";
          a.href = f.data;
          a.download = f.name || "file";
          a.textContent = "üìé " + (f.name || "T·ªáp ƒë√≠nh k√®m");
          filesArea.appendChild(a);
        }
      });
    }
    postEl.appendChild(filesArea);

    // actions (like)
    const actions = document.createElement("div");
    actions.className = "post-actions";
    const likeBtn = document.createElement("button");
    const liked = me && p.likes && p.likes.includes(me.username);
    likeBtn.innerHTML = (liked ? "üíô" : "ü§ç") + " " + (p.likes ? p.likes.length : 0);
    likeBtn.onclick = ()=> { toggleLike(i); };
    actions.appendChild(likeBtn);
    postEl.appendChild(actions);

    // comment box
    const cbox = document.createElement("div");
    cbox.className = "comment-box";

    const input = document.createElement("input");
    input.type = "text";
    input.id = "cmt-" + i;
    input.placeholder = "Vi·∫øt b√¨nh lu·∫≠n...";
    cbox.appendChild(input);

    const sendBtn = document.createElement("button");
    sendBtn.textContent = "G·ª≠i";
    sendBtn.onclick = ()=> addComment(i);
    cbox.appendChild(sendBtn);

    // comment file label + input (multiple)
    const label = document.createElement("label");
    label.style.cursor = "pointer";
    label.textContent = "üìé";
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*,video/*,application/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.rar,.txt";
    fileInput.multiple = true;
    fileInput.style.display = "none";
    fileInput.onchange = function(){ addCommentFiles(i, this); };
    label.appendChild(fileInput);
    cbox.appendChild(label);

    // comments container
    const commentsContainer = document.createElement("div");
    commentsContainer.className = "comments";
    // render existing comments
    if(Array.isArray(p.comments)){
      p.comments.forEach((c,ci)=>{
        const cEl = document.createElement("div");
        cEl.className = "comment";
        const cAv = document.createElement("img");
        cAv.className = "avatar-small";
        cAv.src = c.avatar || DEFAULT_AVATAR;
        cAv.onclick = ()=> showUserPopup(c.user);
        cEl.appendChild(cAv);

        const cContent = document.createElement("div");
        cContent.className = "comment-content";
        cContent.innerHTML = `<b>${c.user}</b> <span class="comment-time">${c.time || ''}</span>
                              <div>${c.text || ""}</div>`;

        // legacy c.img support
        if(c.img && typeof c.img === 'string' && c.img.length){
          const cim = document.createElement("img");
          cim.className = "comment-img";
          cim.src = c.img;
          cim.onclick = ()=> viewImg(c.img);
          cContent.appendChild(cim);
        }
        // new c.files
        if(Array.isArray(c.files) && c.files.length){
          c.files.forEach(cf=>{
            if(cf && cf.type && cf.type.startsWith("image/")){
              const cim = document.createElement("img");
              cim.className = "comment-img";
              cim.src = cf.data;
              cim.onclick = ()=> viewImg(cf.data);
              cContent.appendChild(cim);
            } else if(cf && cf.type && cf.type.startsWith("video/")){
              const cv = document.createElement("video");
              cv.className = "comment-img";
              cv.src = cf.data;
              cv.controls = true;
              cContent.appendChild(cv);
            } else if(cf && cf.data){
              const ca = document.createElement("a");
              ca.className = "file-link";
              ca.href = cf.data;
              ca.download = cf.name || "file";
              ca.textContent = "üìé " + (cf.name || "T·ªáp ƒë√≠nh k√®m");
              cContent.appendChild(ca);
            }
          });
        }

        // like comment and delete
        const likeC = document.createElement("button");
        likeC.className = "like-cmt";
        likeC.textContent = "üëç " + (c.likes || 0);
        likeC.onclick = ()=> { likeComment(i, ci); };
        cContent.appendChild(likeC);

        const delC = document.createElement("button");
        delC.className = "delete-cmt";
        delC.textContent = "‚úñ";
        delC.onclick = ()=> { deleteComment(i, ci); };
        cContent.appendChild(delC);

        cEl.appendChild(cContent);
        commentsContainer.appendChild(cEl);
      });
    }

    cbox.appendChild(commentsContainer);
    postEl.appendChild(cbox);

    container.appendChild(postEl);
  });
}

/* ====== Actions ====== */
function toggleLike(i){
  const user = getCurrentUser();
  if(!user) return alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
  const posts = getPosts();
  const likes = posts[i].likes || [];
  const idx = likes.indexOf(user.username);
  if(idx === -1) likes.push(user.username); else likes.splice(idx,1);
  posts[i].likes = likes;
  savePosts(posts);
  render();
}

function addComment(i){
  const user = getCurrentUser();
  if(!user) return alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
  const input = document.getElementById("cmt-"+i);
  const text = input ? input.value.trim() : "";
  if(!text) return;
  const posts = getPosts();
  posts[i].comments = posts[i].comments || [];
  posts[i].comments.push({
    user: user.username,
    avatar: user.avatar || DEFAULT_AVATAR,
    text: text,
    time: now(),
    likes: 0
  });
  savePosts(posts);
  render();
}

/* add files to comment (multiple) */
function addCommentFiles(i, fileInput){
  const user = getCurrentUser();
  if(!user) return alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
  const files = fileInput.files;
  if(!files || files.length === 0) return;
  readFilesToData(files, function(fileData){
    const posts = getPosts();
    posts[i].comments = posts[i].comments || [];
    posts[i].comments.push({
      user: user.username,
      avatar: user.avatar || DEFAULT_AVATAR,
      text: "", // no text
      files: fileData,
      time: now(),
      likes: 0
    });
    savePosts(posts);
    render();
  });
}

function deletePost(i){
  const user = getCurrentUser();
  const posts = getPosts();
  if(!user || posts[i].user !== user.username) return alert("B·∫°n ch·ªâ c√≥ th·ªÉ x√≥a b√†i c·ªßa m√¨nh.");
  posts.splice(i,1);
  savePosts(posts);
  render();
}

function deleteComment(pi,ci){
  const user = getCurrentUser();
  const posts = getPosts();
  if(!user || !posts[pi] || !posts[pi].comments || posts[pi].comments[ci].user !== user.username) return alert("B·∫°n ch·ªâ c√≥ th·ªÉ x√≥a b√¨nh lu·∫≠n c·ªßa m√¨nh.");
  posts[pi].comments.splice(ci,1);
  savePosts(posts);
  render();
}

function likeComment(pi,ci){
  const posts = getPosts();
  posts[pi].comments[ci].likes = (posts[pi].comments[ci].likes || 0) + 1;
  savePosts(posts);
  render();
}

function viewImg(src){
  // open only images in overlay
  const box = document.getElementById("imgView");
  box.style.display = "flex";
  box.querySelector("img").src = src;
}
document.getElementById("imgView").onclick = ()=> document.getElementById("imgView").style.display = "none";

/* ====== Popup ng∆∞·ªùi d√πng (kept original behaviour) ====== */
function showUserPopup(username){
  const user = getUsers().find(u=>u.username===username);
  if(!user) return alert("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.");
  const me = getCurrentUser();
  const box = document.createElement("div");
  box.style.position="fixed";
  box.style.inset="0";
  box.style.background="rgba(0,0,0,0.5)";
  box.style.display="flex";
  box.style.alignItems="center";
  box.style.justifyContent="center";
  box.innerHTML=`
    <div style="background:white;border-radius:12px;padding:20px;width:300px;box-shadow:0 6px 20px rgba(0,0,0,0.3);text-align:center;">
      <img src="${user.avatar||DEFAULT_AVATAR}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">
      <h3>${user.username}</h3>
      <p style="font-size:14px;color:#555;">ID: ${user.id||'(·∫®n)'}</p>
      <p style="font-size:13px;color:#777;">${user.desc||'Kh√¥ng c√≥ m√¥ t·∫£.'}</p>
      ${me && me.username!==user.username ? `<button id="inviteBtn" style="padding:8px 12px;border:0;background:#0072ff;color:#fff;border-radius:8px;cursor:pointer;">G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n</button>`:''}
      <div style="margin-top:10px;"><button id="closePopup" style="border:0;background:#ccc;border-radius:6px;padding:6px 12px;cursor:pointer;">ƒê√≥ng</button></div>
    </div>`;
  document.body.appendChild(box);

  box.querySelector("#closePopup").onclick = ()=> box.remove();

  const btn = box.querySelector("#inviteBtn");
  if(btn){
    btn.onclick = ()=> {
      const invites = getInvites();
      const meNow = getCurrentUser();
      if(!meNow) { alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i l·ªùi m·ªùi."); return; }
      if(invites.some(i=>i.to===user.username && i.fromName===meNow.username)){
        alert("B·∫°n ƒë√£ g·ª≠i l·ªùi m·ªùi r·ªìi!"); return;
      }
      invites.push({to:user.username,fromName:meNow.username,fromId:meNow.id,fromAvatar:meNow.avatar||DEFAULT_AVATAR});
      saveInvites(invites);
      alert("ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!");
      box.remove();
    };
  }
}

/* initial render */
render();
</script>

</body>
</html>
