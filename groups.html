<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nh√≥m h·ªçc t·∫≠p</title>
<style>
:root{
  --bg:#f5f8ff; --card:#fff; --accent:#0072ff; --muted:#6b7280;
  --danger:#ef4444;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#111}
header{background:var(--card);padding:12px 20px;border-bottom:1px solid #e6eef8;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#00c6ff,#0072ff);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
nav a{margin-left:12px;text-decoration:none;color:#111;font-weight:600}
.container{max-width:1200px;margin:28px auto;padding:0 16px}
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px;flex-wrap:wrap}
.title{font-size:20px;font-weight:700}
.btn{background:var(--accent);color:#fff;border:0;padding:9px 14px;border-radius:8px;cursor:pointer}
.small{font-size:13px;padding:6px 8px;border-radius:8px;border:0;cursor:pointer}
.small.ghost{background:transparent;border:1px solid #e6eef8}
.small.warn{background:var(--danger);color:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);display:flex;flex-direction:column;justify-content:space-between;min-height:120px}
.meta{font-size:13px;color:var(--muted);margin-top:8px}
.actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.empty{color:var(--muted);padding:18px;background:#fff;border-radius:10px;text-align:center;box-shadow:0 6px 18px rgba(2,6,23,0.03)}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:80}
.modal{background:var(--card);padding:18px;border-radius:12px;max-width:720px;width:92%;max-height:90vh;overflow:auto}
input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eaf5;margin-top:6px}
textarea{min-height:90px;resize:vertical}
.searchWrap{display:flex;gap:8px;align-items:center}

/* Chat ‚Äî messenger-like */
.chat-window{position:fixed;right:18px;bottom:18px;width:520px;height:640px;background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.18);display:flex;flex-direction:column;overflow:hidden;z-index:99}
.chat-header{padding:12px;background:linear-gradient(90deg,#0ea5ff,#0066ff);color:#fff;display:flex;align-items:center;justify-content:space-between;gap:8px}
.chat-header .left{display:flex;gap:10px;align-items:center}
.chat-header img{width:44px;height:44px;border-radius:8px;object-fit:cover}
.chat-body{flex:1;padding:12px;overflow:auto;background:#f5f7fb;display:flex;flex-direction:column;gap:10px}
.thread{display:flex;flex-direction:column;gap:12px}
.msg{display:flex;gap:8px;align-items:flex-end;max-width:100%}
.msg.me{justify-content:flex-end}
.avatar-sm{width:36px;height:36px;border-radius:10px;object-fit:cover}
.bubble{max-width:72%;padding:10px 12px;border-radius:12px;background:#fff;box-shadow:0 4px 10px rgba(2,6,23,0.04);word-break:break-word}
.bubble.me{background:#d7f3ff}
.bubble img{max-width:220px;border-radius:8px;display:block;margin-top:8px}
.meta-small{font-size:12px;color:var(--muted);margin-top:6px}
.chat-input{display:flex;padding:8px;border-top:1px solid #eee;gap:8px;align-items:center}
.chat-input input{flex:1;padding:10px;border-radius:20px;border:1px solid #e6eef8}
.chat-input .btn{padding:8px 12px;border-radius:20px}

/* responsive */
@media(max-width:820px){
  .chat-window{width:94%;right:3%;bottom:8px;height:60vh}
  .grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ED</div>
    <div>
      <div style="font-weight:700">Nh√≥m h·ªçc t·∫≠p</div>
      <div style="font-size:12px;color:var(--muted)">T·∫°o, y√™u c·∫ßu tham gia, qu·∫£n l√Ω v√† tr√≤ chuy·ªán</div>
    </div>
  </div>
  <nav>
    <a href="index.html">Trang ch·ªß</a>
    <a href="community.html" style="margin-left:12px">C·ªông ƒë·ªìng</a>
  </nav>
</header>

<main class="container">
  <div class="toolbar">
    <div class="searchWrap">
      <input id="searchInput" placeholder="T√¨m nh√≥m (g√µ 1 ph·∫ßn t√™n c≈©ng ƒë∆∞·ª£c)"/>
      <button id="searchBtn" class="small ghost">T√¨m</button>
      <button id="clearSearch" class="small ghost" style="display:none">H·ªßy t√¨m</button>
    </div>
    <div>
      <button id="btnCreate" class="btn">T·∫°o nh√≥m m·ªõi</button>
    </div>
  </div>

  <section style="margin-bottom:18px">
    <h3 style="margin-bottom:10px">G·ª£i √Ω nh√≥m n·ªïi b·∫≠t</h3>
    <div id="suggestedArea" class="grid"></div>
    <div id="suggestEmpty" class="empty" style="display:none;margin-top:12px">Ch∆∞a c√≥ nh√≥m ƒë·ªÉ g·ª£i √Ω.</div>
  </section>

  <section>
    <h3 style="margin-bottom:10px">Nh√≥m </h3>
    <div id="groupsGrid" class="grid"></div>
    <div id="noGroups" class="empty" style="margin-top:12px;display:none">Ch∆∞a c√≥ nh√≥m n√†o ‚Äî h√£y t·∫°o nh√≥m ƒë·∫ßu ti√™n!</div>
  </section>
</main>

<!-- Modal t·∫°o nh√≥m -->
<div id="modalCreate" class="backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>T·∫°o nh√≥m m·ªõi</h3>
    <label>T√™n nh√≥m</label>
    <input id="inputGroupName" placeholder="V√≠ d·ª•: Nh√≥m L·∫≠p tr√¨nh JS" />
    <label>M√¥ t·∫£</label>
    <textarea id="inputGroupDesc" placeholder="M·ª•c ti√™u, n·ªôi quy ng·∫Øn..."></textarea>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="cancelCreate" class="small ghost">H·ªßy</button>
      <button id="confirmCreate" class="small" style="background:var(--accent);color:#fff">T·∫°o</button>
    </div>
  </div>
</div>

<!-- Modal confirm -->
<div id="modalConfirm" class="backdrop">
  <div class="modal">
    <h3 id="confirmTitle">X√°c nh·∫≠n</h3>
    <p id="confirmMsg">B·∫°n c√≥ ch·∫Øc?</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="small">H·ªßy</button>
      <button id="confirmOk" class="small warn">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>

<!-- Chat window -->
<div id="chatWindow" class="chat-window" style="display:none" role="dialog" aria-modal="true">
  <div class="chat-header">
    <div class="left">
      <img id="chatAvatar" src="" alt="avatar">
      <div>
        <div id="chatTitle" style="font-weight:700"></div>
        <div id="chatMeta" style="font-size:12px;opacity:0.9"></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <label style="cursor:pointer;color:#fff">üì∑<input id="chatImageInput" type="file" accept="image/*" style="display:none"></label>
      <button id="closeChat" class="small ghost">ƒê√≥ng</button>
    </div>
  </div>

  <div id="chatBody" class="chat-body">
    <!-- messages rendered here -->
  </div>

  <div class="chat-input">
    <input id="chatInput" placeholder="G·ª≠i tin nh·∫Øn..." />
    <button id="chatSend" class="btn">G·ª≠i</button>
  </div>
</div>

<script>
/* ========= Helpers & storage ========= */
const DEFAULT_AVATAR = 'https://i.imgur.com/PHv4T6B.png';
const uid = () => 'g' + Date.now().toString(36).slice(2,10);

function getUsers(){ return JSON.parse(localStorage.getItem('users')||'[]'); }
function getCurrentUser(){ const u = localStorage.getItem('username'); if(!u) return null; return getUsers().find(x=>x.username===u) || null; }
function getGroups(){ return JSON.parse(localStorage.getItem('groups')||'[]'); }
function saveGroups(gs){ localStorage.setItem('groups', JSON.stringify(gs)); }
function getChats(){ return JSON.parse(localStorage.getItem('groupChats')||'{}'); }
function saveChats(c){ localStorage.setItem('groupChats', JSON.stringify(c)); }
function getJoinRequests(){ return JSON.parse(localStorage.getItem('groupJoinRequests')||'[]'); }
function saveJoinRequests(r){ localStorage.setItem('groupJoinRequests', JSON.stringify(r)); }
function timeNow(){ return new Date().toLocaleString('vi-VN',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',year:'numeric'}); }
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ========= Elements ========= */
const suggestedArea = document.getElementById('suggestedArea');
const suggestEmpty = document.getElementById('suggestEmpty');
const groupsGrid = document.getElementById('groupsGrid');
const noGroups = document.getElementById('noGroups');
const btnCreate = document.getElementById('btnCreate');
const modalCreate = document.getElementById('modalCreate');
const inputGroupName = document.getElementById('inputGroupName');
const inputGroupDesc = document.getElementById('inputGroupDesc');
const cancelCreate = document.getElementById('cancelCreate');
const confirmCreate = document.getElementById('confirmCreate');

const modalConfirm = document.getElementById('modalConfirm');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMsg = document.getElementById('confirmMsg');
const confirmCancel = document.getElementById('confirmCancel');
const confirmOk = document.getElementById('confirmOk');

const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearch = document.getElementById('clearSearch');

const chatWindow = document.getElementById('chatWindow');
const chatTitle = document.getElementById('chatTitle');
const chatMeta = document.getElementById('chatMeta');
const chatAvatar = document.getElementById('chatAvatar');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const closeChat = document.getElementById('closeChat');
const chatImageInput = document.getElementById('chatImageInput');

/* ========= Initial cleanup (remove sample groups) ========= */
(function cleanupSampleGroups(){
  const sampleNames = ["S√°ch & VƒÉn H·ªçc","C√¥ng Ngh·ªá & L·∫≠p Tr√¨nh","S·ªëng Kh·ªèe M·ªói Ng√†y"];
  let gs = getGroups();
  const before = gs.length;
  gs = gs.filter(g => !sampleNames.some(n => g.name && g.name.toLowerCase() === n.toLowerCase()));
  if(gs.length !== before) saveGroups(gs);
})();

/* ========= State ========= */
let openChatGroupId = null;
let activeConfirmCallback = null;

/* ========= Utility ========= */
function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className = cls; return e; }
function btn(text, cb, variant){ const b = el('button','small'); if(variant==='ghost') b.classList.add('ghost'); if(variant==='warn') b.classList.add('warn'); b.textContent=text; b.addEventListener('click', cb); return b; }

/* ========= Render suggested top-3 by members ========= */
function renderSuggested(){
  const gs = getGroups().filter(g => g.owner && g.owner !== '(·∫®n)');
  if(!gs.length){ suggestedArea.innerHTML=''; suggestEmpty.style.display='block'; return; }
  suggestEmpty.style.display='none';
  const sorted = [...gs].sort((a,b)=>(b.members?.length||0)-(a.members?.length||0)).slice(0,3);
  suggestedArea.innerHTML = '';
  sorted.forEach(g=>{
    const card = el('div','card');
    card.innerHTML = `<div><h4 style="margin:0">${escapeHtml(g.name)}</h4>
      <div class="meta">Ch·ªß: <strong>${escapeHtml(g.owner)}</strong> ‚Ä¢ ${(g.members||[]).length} th√†nh vi√™n</div>
      <p style="margin-top:8px;color:var(--muted)">${escapeHtml(g.desc||'')}</p></div>`;
    const actions = el('div','actions');
    actions.appendChild(btn('Xem', ()=> viewGroup(g.id)));
    card.appendChild(actions);
    suggestedArea.appendChild(card);
  });
}

/* ========= Render all groups (full list or filtered) ========= */
function renderGroups(filtered=null){
  const list = filtered || getGroups();
  groupsGrid.innerHTML = '';
  if(!list.length){ noGroups.style.display='block'; return; } else noGroups.style.display='none';
  const me = getCurrentUser();
  list.forEach(g=>{
    const card = el('div','card');
    card.innerHTML = `<div><h3>${escapeHtml(g.name)}</h3>
      <div class="meta">Ch·ªß: <strong>${escapeHtml(g.owner)}</strong> ‚Ä¢ ${(g.members||[]).length} th√†nh vi√™n</div>
      <p style="margin-top:8px;color:var(--muted)">${escapeHtml(g.desc||'')}</p></div>`;
    const actions = el('div','actions');
    // actions vary by role
    if(!me){
      actions.appendChild(btn('ƒêƒÉng nh·∫≠p ƒë·ªÉ tham gia', ()=> alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông n√†y.'), 'ghost'));
    } else {
      const amOwner = (me.username === g.owner);
      const isMember = (g.members||[]).includes(me.username);
      const pending = getJoinRequests().some(r=>r.groupId===g.id && r.from===me.username);
      if(amOwner){
        actions.appendChild(btn('Duy·ªát y√™u c·∫ßu', ()=> manageJoinRequests(g.id)));
        actions.appendChild(btn('Tr√≤ chuy·ªán', ()=> openChat(g.id)));
        actions.appendChild(btn('X√≥a nh√≥m', ()=> confirmDeleteGroup(g.id), 'warn'));
      } else if(isMember){
        actions.appendChild(btn('R·ªùi nh√≥m', ()=> leaveGroup(g.id), 'ghost'));
        actions.appendChild(btn('Tr√≤ chuy·ªán', ()=> openChat(g.id)));
      } else if(pending){
        actions.appendChild(btn('ƒê√£ y√™u c·∫ßu', ()=> alert('B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu tham gia. Ch·ªù ch·ªß nh√≥m duy·ªát.'), 'ghost'));
      } else {
        actions.appendChild(btn('Y√™u c·∫ßu tham gia', ()=> requestToJoin(g.id)));
      }
    }
    card.appendChild(actions);
    groupsGrid.appendChild(card);
  });
}

/* ========= View group quick (if member open chat, else show info + request) ========= */
function viewGroup(groupId){
  const g = getGroups().find(x=>x.id===groupId);
  if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  const me = getCurrentUser();
  if(me && (g.members||[]).includes(me.username)){
    openChat(groupId);
  } else {
    let info = `Nh√≥m: ${g.name}\nCh·ªß: ${g.owner}\nTh√†nh vi√™n: ${(g.members||[]).length}\n\n${g.desc||''}`;
    if(me){
      if(confirm(info + '\n\nB·∫°n c√≥ mu·ªën g·ª≠i y√™u c·∫ßu tham gia?')) requestToJoin(groupId);
    } else {
      alert(info + '\n\nB·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i y√™u c·∫ßu tham gia.');
    }
  }
}

/* ========= Create group ========= */
btnCreate.addEventListener('click', ()=>{
  if(!getCurrentUser()){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o nh√≥m!'); return; }
  inputGroupName.value=''; inputGroupDesc.value='';
  modalCreate.style.display = 'flex';
});
cancelCreate.addEventListener('click', ()=> modalCreate.style.display = 'none');
confirmCreate.addEventListener('click', ()=>{
  const me = getCurrentUser();
  if(!me){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p'); modalCreate.style.display='none'; return; }
  const name = inputGroupName.value.trim();
  const desc = inputGroupDesc.value.trim();
  if(!name) return alert('Vui l√≤ng nh·∫≠p t√™n nh√≥m');
  const gs = getGroups();
  if(gs.some(x=>x.name.toLowerCase() === name.toLowerCase())) return alert('T√™n nh√≥m ƒë√£ t·ªìn t·∫°i');
  const id = uid();
  const newG = { id, name, desc, owner: me.username, members: [me.username], createdAt: Date.now() };
  gs.unshift(newG);
  saveGroups(gs);
  modalCreate.style.display='none';
  renderAll();
  // auto-open chat after creating
  openChat(id);
});

/* ========= Join requests ========= */
function requestToJoin(groupId){
  const me = getCurrentUser();
  if(!me){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p'); return; }
  const reqs = getJoinRequests();
  if(reqs.some(r=>r.groupId===groupId && r.from===me.username)) return alert('B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu r·ªìi.');
  reqs.push({ id: 'r'+Date.now(), groupId, from: me.username, time: Date.now() });
  saveJoinRequests(reqs);
  alert('ƒê√£ g·ª≠i y√™u c·∫ßu tham gia. Ch·ªß nh√≥m s·∫Ω duy·ªát.');
  renderAll();
}

/* Owner reviews join requests */
function manageJoinRequests(groupId){
  const me = getCurrentUser();
  if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  const g = getGroups().find(x=>x.id===groupId);
  if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  if(g.owner !== me.username) return alert('Ch·ªâ ch·ªß nh√≥m m·ªõi c√≥ quy·ªÅn duy·ªát.');
  const reqs = getJoinRequests().filter(r=>r.groupId===groupId);
  if(!reqs.length) return alert('Kh√¥ng c√≥ y√™u c·∫ßu n√†o.');
  // show a simple selection flow
  let message = 'Y√™u c·∫ßu tham gia:\n';
  reqs.forEach((r,i)=> message += `${i+1}. ${r.from}\n`);
  const inp = prompt(message + '\nNh·∫≠p s·ªë th·ª© t·ª± ƒë·ªÉ duy·ªát (v√≠ d·ª• 1) ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ h·ªßy:');
  if(!inp) return;
  const idx = parseInt(inp) - 1;
  if(isNaN(idx) || idx < 0 || idx >= reqs.length) return alert('L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá.');
  const chosen = reqs[idx];
  if(!confirm(`B·∫°n c√≥ ch·∫•p nh·∫≠n ${chosen.from} v√†o nh√≥m "${g.name}"?`)) {
    // remove request
    const all = getJoinRequests().filter(r=>r.id !== chosen.id);
    saveJoinRequests(all);
    renderAll();
    return alert('ƒê√£ t·ª´ ch·ªëi.');
  }
  // accept: add to members and remove request
  let gs = getGroups();
  const gg = gs.find(x=>x.id===groupId);
  if(!gg.members) gg.members = [];
  if(!gg.members.includes(chosen.from)) gg.members.push(chosen.from);
  saveGroups(gs);
  saveJoinRequests(getJoinRequests().filter(r=>r.id !== chosen.id));
  alert('ƒê√£ ch·∫•p nh·∫≠n.');
  renderAll();
}

/* ========= Leave / Delete / Kick ========= */
function leaveGroup(groupId){
  const me = getCurrentUser();
  if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  let gs = getGroups();
  const g = gs.find(x=>x.id===groupId);
  if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  if(g.owner === me.username) return alert('Ch·ªß nh√≥m kh√¥ng th·ªÉ r·ªùi. X√≥a nh√≥m n·∫øu mu·ªën.');
  g.members = (g.members||[]).filter(m=>m!==me.username);
  saveGroups(gs);
  renderAll();
}

function confirmDeleteGroup(groupId){
  const me = getCurrentUser();
  const g = getGroups().find(x=>x.id===groupId);
  if(!g || g.owner !== me.username) return alert('B·∫°n kh√¥ng c√≥ quy·ªÅn.');
  activeConfirmCallback = ()=> {
    // delete group & its chats & related requests
    let gs = getGroups().filter(x=>x.id !== groupId);
    saveGroups(gs);
    const chats = getChats();
    if(chats[groupId]) { delete chats[groupId]; saveChats(chats); }
    saveJoinRequests(getJoinRequests().filter(r=>r.groupId !== groupId));
    modalConfirm.style.display='none';
    renderAll();
    if(openChatGroupId === groupId) closeChatWindow();
  };
  confirmTitle.textContent = 'X√≥a nh√≥m';
  confirmMsg.textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m "${g.name}"?`;
  modalConfirm.style.display = 'flex';
}

function confirmKickMember(groupId, username){
  const me = getCurrentUser();
  const g = getGroups().find(x=>x.id===groupId);
  if(!g || g.owner !== me.username) return alert('B·∫°n kh√¥ng c√≥ quy·ªÅn.');
  activeConfirmCallback = ()=> {
    let gs = getGroups();
    const gg = gs.find(x=>x.id===groupId);
    gg.members = gg.members.filter(m=>m!==username);
    saveGroups(gs);
    modalConfirm.style.display='none';
    renderAll();
  };
  confirmTitle.textContent = 'Kick th√†nh vi√™n';
  confirmMsg.textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën kick ${username} kh·ªèi nh√≥m "${g.name}"?`;
  modalConfirm.style.display='flex';
}

/* modal confirm handlers */
confirmCancel.addEventListener('click', ()=> { modalConfirm.style.display='none'; activeConfirmCallback = null; });
confirmOk.addEventListener('click', ()=> {
  modalConfirm.style.display='none';
  if(typeof activeConfirmCallback === 'function') activeConfirmCallback();
  activeConfirmCallback = null;
});

/* ========= Chat logic (Messenger-like) ========= */
let openChatGroupId = null;

function openChat(groupId){
  const me = getCurrentUser();
  if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ chat.');
  const g = getGroups().find(x=>x.id===groupId);
  if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  if(!(g.members||[]).includes(me.username)) return alert('B·∫°n ph·∫£i l√† th√†nh vi√™n ƒë·ªÉ chat trong nh√≥m n√†y.');
  openChatGroupId = groupId;
  chatTitle.textContent = g.name;
  chatMeta.textContent = `${(g.members||[]).length} th√†nh vi√™n ‚Ä¢ Ch·ªß: ${g.owner}`;
  chatAvatar.src = (getUsers().find(u=>u.username===g.owner)?.avatar) || DEFAULT_AVATAR;
  chatWindow.style.display = 'flex';
  renderChat();
}

function closeChatWindow(){
  chatWindow.style.display = 'none';
  openChatGroupId = null;
  chatBody.innerHTML = '';
}
closeChat.addEventListener('click', ()=> closeChatWindow());

function renderChat(){
  if(!openChatGroupId) return;
  const chats = getChats();
  const msgs = chats[openChatGroupId] || [];
  chatBody.innerHTML = '';
  const me = getCurrentUser();
  msgs.forEach((m, idx) => {
    const row = el('div','msg' + ((m.from === (me && me.username)) ? ' me' : ''));
    const avatarEl = el('img','avatar-sm');
    avatarEl.src = (getUsers().find(u=>u.username===m.from)?.avatar) || DEFAULT_AVATAR;
    avatarEl.title = m.from;
    const bubble = el('div','bubble' + ((m.from === (me && me.username)) ? ' me' : ''));
    // header: name + time
    const headerHtml = `<div style="font-size:13px;margin-bottom:6px"><strong>${escapeHtml(m.from)}</strong> <span style="font-size:11px;color:var(--muted);margin-left:8px">${escapeHtml(m.time)}</span></div>`;
    bubble.innerHTML = headerHtml + `<div>${escapeHtml(m.text||'')}</div>`;
    if(m.image){
      const imgHtml = `<div><img src="${m.image}" alt="img"></div>`;
      bubble.innerHTML += imgHtml;
    }
    // delete control: sender or owner can delete message
    const g = getGroups().find(x=>x.id===openChatGroupId);
    if(me && (m.from === me.username || (g && g.owner === me.username))){
      const delBtn = el('button','small ghost');
      delBtn.textContent = '‚úñ';
      delBtn.style.marginLeft = '8px';
      delBtn.addEventListener('click', ()=>{
        if(!confirm('X√≥a tin nh·∫Øn n√†y?')) return;
        const all = getChats();
        all[openChatGroupId] = all[openChatGroupId].filter((_,i)=>i!==idx);
        saveChats(all);
        renderChat();
      });
      bubble.appendChild(delBtn);
    }

    if(m.from === (me && me.username)){
      row.appendChild(bubble);
      row.appendChild(avatarEl);
      row.classList.add('me');
    } else {
      row.appendChild(avatarEl);
      row.appendChild(bubble);
    }
    chatBody.appendChild(row);
  });
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* send message */
chatSend.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } });

function sendChat(){
  const text = chatInput.value.trim();
  if(!openChatGroupId) return alert('M·ªü chat nh√≥m tr∆∞·ªõc khi g·ª≠i tin nh·∫Øn.');
  if(!text && !chatPendingImage) return;
  const me = getCurrentUser();
  if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  const chats = getChats();
  if(!chats[openChatGroupId]) chats[openChatGroupId] = [];
  const msg = { from: me.username, text: text || '', time: timeNow() };
  if(chatPendingImage){ msg.image = chatPendingImage; chatPendingImage = null; }
  chats[openChatGroupId].push(msg);
  saveChats(chats);
  chatInput.value = '';
  renderChat();
}

/* send image via input */
let chatPendingImage = null;
chatImageInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const me = getCurrentUser();
  if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  if(!openChatGroupId) return alert('M·ªü chat nh√≥m tr∆∞·ªõc khi g·ª≠i ·∫£nh.');
  const reader = new FileReader();
  reader.onload = ev => {
    const data = ev.target.result;
    const chats = getChats();
    if(!chats[openChatGroupId]) chats[openChatGroupId] = [];
    chats[openChatGroupId].push({ from: me.username, text: '', image: data, time: timeNow() });
    saveChats(chats);
    chatImageInput.value = '';
    renderChat();
  };
  reader.readAsDataURL(f);
});

/* ========= Search groups (partial match) ========= */
searchBtn.addEventListener('click', ()=> {
  const q = (searchInput.value||'').trim().toLowerCase();
  if(!q) return alert('Nh·∫≠p t·ª´ kh√≥a t√¨m nh√≥m.');
  const gs = getGroups();
  const matched = gs.filter(g=> g.name.toLowerCase().includes(q) || (g.desc||'').toLowerCase().includes(q));
  renderGroups(matched);
  clearSearch.style.display = 'inline-block';
});
clearSearch.addEventListener('click', ()=> {
  searchInput.value = '';
  renderAll();
  clearSearch.style.display = 'none';
});
searchInput.addEventListener('keydown',(e)=> { if(e.key === 'Enter') searchBtn.click(); });


/* ========= Render combined ========= */
function renderAll(){
  renderSuggested();
  renderGroups();
}

/* ========= Init: ensure keys exist and render ========= */
if(!localStorage.getItem('groups')) saveGroups([]);
if(!localStorage.getItem('groupChats')) saveChats({});
if(!localStorage.getItem('groupJoinRequests')) saveJoinRequests([]);
renderAll();

/* modal click outside to close */
document.querySelectorAll('.backdrop').forEach(b=>{
  b.addEventListener('click', e=>{
    if(e.target === b) b.style.display = 'none';
  });
});

/* Expose helpers for debugging if needed */
window._renderGroups = renderAll;
window._getGroups = getGroups;
window._getChats = getChats;

</script>
</body>
</html>

