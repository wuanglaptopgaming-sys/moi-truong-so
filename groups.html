<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nh√≥m h·ªçc t·∫≠p</title>
<style>
:root{
  --bg:#f5f8ff; --card:#fff; --accent:#0072ff; --muted:#6b7280; --danger:#ef4444;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#111}
header{background:var(--card);padding:12px 20px;border-bottom:1px solid #e6eef8;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#00c6ff,#0072ff);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
nav a{margin-left:12px;text-decoration:none;color:#111;font-weight:600}
.container{max-width:1200px;margin:28px auto;padding:0 16px}
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px;flex-wrap:wrap}
.title{font-size:20px;font-weight:700}
.btn{background:var(--accent);color:#fff;border:0;padding:9px 14px;border-radius:8px;cursor:pointer}
.small{font-size:13px;padding:6px 8px;border-radius:8px;border:0;cursor:pointer}
.small.ghost{background:transparent;border:1px solid #e6eef8}
.small.warn{background:var(--danger);color:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);display:flex;flex-direction:column;justify-content:space-between;min-height:120px}
.meta{font-size:13px;color:var(--muted);margin-top:8px}
.actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.empty{color:var(--muted);padding:18px;background:#fff;border-radius:10px;text-align:center;box-shadow:0 6px 18px rgba(2,6,23,0.03)}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:80}
.modal{background:var(--card);padding:18px;border-radius:12px;max-width:720px;width:92%;max-height:90vh;overflow:auto}
input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eaf5;margin-top:6px}
textarea{min-height:90px;resize:vertical}
.searchWrap{display:flex;gap:8px;align-items:center}

/* Chat ‚Äî messenger-like */
.chat-window{position:fixed;right:18px;bottom:18px;width:520px;height:640px;background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.18);display:flex;flex-direction:column;overflow:hidden;z-index:99}
.chat-header{padding:12px;background:linear-gradient(90deg,#0ea5ff,#0066ff);color:#fff;display:flex;align-items:center;justify-content:space-between;gap:8px}
.chat-header .left{display:flex;gap:10px;align-items:center}
.chat-header img{width:44px;height:44px;border-radius:8px;object-fit:cover}
.chat-body{flex:1;padding:12px;overflow:auto;background:#f5f7fb;display:flex;flex-direction:column;gap:10px}
.thread{display:flex;flex-direction:column;gap:12px}
.msg{display:flex;gap:8px;align-items:flex-end;max-width:100%}
.msg.me{justify-content:flex-end}
.avatar-sm{width:36px;height:36px;border-radius:10px;object-fit:cover;cursor:pointer}
.bubble{max-width:72%;padding:10px 12px;border-radius:12px;background:#fff;box-shadow:0 4px 10px rgba(2,6,23,0.04);word-break:break-word}
.bubble.me{background:#d7f3ff}
.bubble img{max-width:220px;border-radius:8px;display:block;margin-top:8px}
.meta-small{font-size:12px;color:var(--muted);margin-top:6px}
.chat-input{display:flex;padding:8px;border-top:1px solid #eee;gap:8px;align-items:center}
.chat-input input{flex:1;padding:10px;border-radius:20px;border:1px solid #e6eef8}
.chat-input .btn{padding:8px 12px;border-radius:20px}
.file-card{background:#fff;border:1px solid #e6eaf5;padding:10px;border-radius:10px;display:flex;flex-direction:column;gap:6px;align-items:flex-start}

/* invite bell & panel */
.invite-bell{position:relative;display:inline-block;margin-left:12px;cursor:pointer}
.invite-bell .badge{position:absolute;top:-6px;right:-6px;background:#ef4444;color:white;border-radius:999px;padding:3px 6px;font-size:12px}
.invite-panel{position:absolute;right:0;top:36px;width:320px;background:white;border:1px solid #e6eef8;box-shadow:0 8px 24px rgba(2,6,23,0.12);border-radius:8px;display:none;z-index:200;padding:8px}
.invite-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f1f5f9}
.invite-item .meta{font-size:13px;color:var(--muted)}

/* invite modal (invite friends into group) */
.invite-modal .friend-row{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:8px;justify-content:space-between}
.user-avatar{cursor:pointer;color:var(--accent);text-decoration:underline}
@media(max-width:820px){
  .chat-window{width:94%;right:3%;bottom:8px;height:60vh}
  .grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ED</div>
    <div>
      <div style="font-weight:700">Nh√≥m h·ªçc t·∫≠p</div>
    </div>
  </div>
  <nav>
    <a href="index.html">Trang ch·ªß</a>
    <a href="community.html" style="margin-left:12px">C·ªông ƒë·ªìng</a>
    <!-- Invite bell -->
    <span id="inviteBellWrap" class="invite-bell" title="L·ªùi m·ªùi nh√≥m">
      üîî <span id="inviteBadge" class="badge" style="display:none">0</span>
      <div id="invitePanel" class="invite-panel" aria-hidden="true"></div>
    </span>
  </nav>
</header>

<main class="container">
  <div class="toolbar">
    <div class="searchWrap">
      <input id="searchInput" placeholder="T√¨m nh√≥m (g√µ 1 ph·∫ßn t√™n c≈©ng ƒë∆∞·ª£c)"/>
      <button id="searchBtn" class="small ghost">T√¨m</button>
      <button id="clearSearch" class="small ghost" style="display:none">H·ªßy t√¨m</button>
    </div>
    <div>
      <button id="btnCreate" class="btn">T·∫°o nh√≥m m·ªõi</button>
    </div>
  </div>

  <section style="margin-bottom:18px">
    <h3 style="margin-bottom:10px">G·ª£i √Ω nh√≥m n·ªïi b·∫≠t</h3>
    <div id="suggestedArea" class="grid"></div>
    <div id="suggestEmpty" class="empty" style="display:none;margin-top:12px">Ch∆∞a c√≥ nh√≥m ƒë·ªÉ g·ª£i √Ω.</div>
  </section>

  <section>
    <h3 style="margin-bottom:10px">T·∫•t c·∫£ nh√≥m (do ng∆∞·ªùi d√πng t·∫°o)</h3>
    <div id="groupsGrid" class="grid"></div>
    <div id="noGroups" class="empty" style="margin-top:12px;display:none">Ch∆∞a c√≥ nh√≥m n√†o ‚Äî h√£y t·∫°o nh√≥m ƒë·∫ßu ti√™n!</div>
  </section>
</main>

<!-- Modal t·∫°o nh√≥m -->
<div id="modalCreate" class="backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>T·∫°o nh√≥m m·ªõi</h3>
    <label>T√™n nh√≥m</label>
    <input id="inputGroupName" placeholder="V√≠ d·ª•: Nh√≥m L·∫≠p tr√¨nh JS" />
    <label>M√¥ t·∫£</label>
    <textarea id="inputGroupDesc" placeholder="M·ª•c ti√™u, n·ªôi quy ng·∫Øn..."></textarea>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="cancelCreate" class="small ghost">H·ªßy</button>
      <button id="confirmCreate" class="small" style="background:var(--accent);color:#fff">T·∫°o</button>
    </div>
  </div>
</div>

<!-- Modal invite friends to group -->
<div id="inviteModal" class="backdrop invite-modal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>M·ªùi b·∫°n v√†o nh√≥m</h3>
    <div id="inviteFriendList"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="closeInviteModal" class="small ghost">ƒê√≥ng</button>
    </div>
  </div>
</div>

<!-- Modal confirm -->
<div id="modalConfirm" class="backdrop">
  <div class="modal">
    <h3 id="confirmTitle">X√°c nh·∫≠n</h3>
    <p id="confirmMsg">B·∫°n c√≥ ch·∫Øc?</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="small">H·ªßy</button>
      <button id="confirmOk" class="small warn">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>

<!-- Chat window -->
<div id="chatWindow" class="chat-window" style="display:none" role="dialog" aria-modal="true">
  <div class="chat-header">
    <div class="left">
      <img id="chatAvatar" src="" alt="avatar">
      <div>
        <div id="chatTitle" style="font-weight:700"></div>
        <div id="chatMeta" style="font-size:12px;opacity:0.9"></div>
      </div>
    </div>
    <div>
      <button id="closeChat" class="small ghost">ƒê√≥ng</button>
    </div>
  </div>

  <div id="chatBody" class="chat-body"></div>

  <div class="chat-input">
    <input id="chatInput" placeholder="G·ª≠i tin nh·∫Øn..." />
    <label class="small ghost" style="cursor:pointer;padding:6px 10px;border-radius:8px;display:inline-flex;align-items:center;gap:6px;">
      üìé
      <input id="chatFileInput" type="file" accept="*/*" multiple style="display:none">
    </label>
    <button id="chatSend" class="btn">G·ª≠i</button>
  </div>
</div>

<script>
/* ========== Helpers & storage ========== */
const DEFAULT_AVATAR = 'https://i.imgur.com/PHv4T6B.png';
const uid = () => 'g' + Date.now().toString(36).slice(2,10);

function getUsers(){ return JSON.parse(localStorage.getItem('users')||'[]'); }
function getCurrentUser(){ const u = localStorage.getItem('username'); if(!u) return null; return getUsers().find(x=>x.username===u) || null; }
function getGroups(){ return JSON.parse(localStorage.getItem('groups')||'[]'); }
function saveGroups(gs){ localStorage.setItem('groups', JSON.stringify(gs)); }
function getChats(){ return JSON.parse(localStorage.getItem('groupChats')||'{}'); }
function saveChats(c){ localStorage.setItem('groupChats', JSON.stringify(c)); }
function getJoinRequests(){ return JSON.parse(localStorage.getItem('groupJoinRequests')||'[]'); }
function saveJoinRequests(r){ localStorage.setItem('groupJoinRequests', JSON.stringify(r)); }
function getGroupInvites(){ return JSON.parse(localStorage.getItem('groupInvites')||'[]'); }
function saveGroupInvites(arr){ localStorage.setItem('groupInvites', JSON.stringify(arr)); }
function timeNow(){ return new Date().toLocaleString('vi-VN',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',year:'numeric'}); }
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ========== Elements ========== */
const suggestedArea = document.getElementById('suggestedArea');
const suggestEmpty = document.getElementById('suggestEmpty');
const groupsGrid = document.getElementById('groupsGrid');
const noGroups = document.getElementById('noGroups');
const btnCreate = document.getElementById('btnCreate');
const modalCreate = document.getElementById('modalCreate');
const inputGroupName = document.getElementById('inputGroupName');
const inputGroupDesc = document.getElementById('inputGroupDesc');
const cancelCreate = document.getElementById('cancelCreate');
const confirmCreate = document.getElementById('confirmCreate');

const modalConfirm = document.getElementById('modalConfirm');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMsg = document.getElementById('confirmMsg');
const confirmCancel = document.getElementById('confirmCancel');
const confirmOk = document.getElementById('confirmOk');

const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearch = document.getElementById('clearSearch');

const chatWindow = document.getElementById('chatWindow');
const chatTitle = document.getElementById('chatTitle');
const chatMeta = document.getElementById('chatMeta');
const chatAvatar = document.getElementById('chatAvatar');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const closeChat = document.getElementById('closeChat');
const chatFileInput = document.getElementById('chatFileInput');

// invite UI
const inviteBellWrap = document.getElementById('inviteBellWrap');
const inviteBadge = document.getElementById('inviteBadge');
const invitePanel = document.getElementById('invitePanel');
const inviteModal = document.getElementById('inviteModal');
const inviteFriendList = document.getElementById('inviteFriendList');
const closeInviteModal = document.getElementById('closeInviteModal');

/* ========== Initial cleanup (remove sample groups if present) ========= */
(function cleanupSampleGroups(){
  const sampleNames = ["S√°ch & VƒÉn H·ªçc","C√¥ng Ngh·ªá & L·∫≠p Tr√¨nh","S·ªëng Kh·ªèe M·ªói Ng√†y"];
  let gs = getGroups();
  const before = gs.length;
  gs = gs.filter(g => !sampleNames.some(n => g.name && g.name.toLowerCase() === n.toLowerCase()));
  if(gs.length !== before) saveGroups(gs);
})();

/* ========== Utility ========== */
function el(tag, cls){ const e = document.createElement(tag); if(cls) e.className = cls; return e; }
function btn(text, cb, variant){ const b = el('button','small'); if(variant==='ghost') b.classList.add('ghost'); if(variant==='warn') b.classList.add('warn'); b.textContent = text; b.addEventListener('click', cb); return b; }

/* ========== Render suggested top-3 by members ========= */
function renderSuggested(){
  const gs = getGroups().filter(g => g.owner && g.owner !== '(·∫®n)');
  if(!gs.length){ suggestedArea.innerHTML=''; suggestEmpty.style.display='block'; return; }
  suggestEmpty.style.display='none';
  const sorted = [...gs].sort((a,b)=>(b.members?.length||0)-(a.members?.length||0)).slice(0,3);
  suggestedArea.innerHTML = '';
  sorted.forEach(g=>{
    const card = el('div','card');
    card.innerHTML = `<div><h4 style="margin:0">${escapeHtml(g.name)}</h4>
      <div class="meta">Ch·ªß: <strong class="user-avatar" data-username="${escapeHtml(g.owner)}">${escapeHtml(g.owner)}</strong> ‚Ä¢ ${(g.members||[]).length} th√†nh vi√™n</div>
      <p style="margin-top:8px;color:var(--muted)">${escapeHtml(g.desc||'')}</p></div>`;
    const actions = el('div','actions');
    actions.appendChild(btn('Xem', ()=> viewGroup(g.id)));
    actions.appendChild(btn('M·ªùi b·∫°n', ()=> openInviteModal(g.id)));
    card.appendChild(actions);
    suggestedArea.appendChild(card);
  });
}

/* ========== Render groups (full or filtered) ========= */
function renderGroups(filtered=null){
  const list = filtered || getGroups();
  groupsGrid.innerHTML = '';
  if(!list.length){ noGroups.style.display='block'; return; } else noGroups.style.display='none';
  const me = getCurrentUser();
  list.forEach(g=>{
    const card = el('div','card');
    card.innerHTML = `<div><h3>${escapeHtml(g.name)}</h3>
      <div class="meta">Ch·ªß: <strong class="user-avatar" data-username="${escapeHtml(g.owner)}">${escapeHtml(g.owner)}</strong> ‚Ä¢ ${(g.members||[]).length} th√†nh vi√™n</div>
      <p style="margin-top:8px;color:var(--muted)">${escapeHtml(g.desc||'')}</p></div>`;
    const actions = el('div','actions');
    if(!me){
      actions.appendChild(btn('ƒêƒÉng nh·∫≠p ƒë·ªÉ tham gia', ()=> alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông n√†y.'), 'ghost'));
    } else {
      const amOwner = (me.username === g.owner);
      const isMember = (g.members||[]).includes(me.username);
      const pending = getJoinRequests().some(r=>r.groupId===g.id && r.from===me.username);
      // Add Invite button for members/owners to invite friends
      if(isMember || amOwner){
        actions.appendChild(btn('M·ªùi b·∫°n', ()=> openInviteModal(g.id)));
      }
      if(amOwner){
        actions.appendChild(btn('Duy·ªát y√™u c·∫ßu', ()=> manageJoinRequests(g.id)));
        actions.appendChild(btn('Tr√≤ chuy·ªán', ()=> openChat(g.id)));
        actions.appendChild(btn('X√≥a nh√≥m', ()=> confirmDeleteGroup(g.id), 'warn'));
      } else if(isMember){
        actions.appendChild(btn('R·ªùi nh√≥m', ()=> leaveGroup(g.id), 'ghost'));
        actions.appendChild(btn('Tr√≤ chuy·ªán', ()=> openChat(g.id)));
      } else if(pending){
        actions.appendChild(btn('ƒê√£ y√™u c·∫ßu', ()=> alert('B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu tham gia. Ch·ªù ch·ªß nh√≥m duy·ªát.'), 'ghost'));
      } else {
        actions.appendChild(btn('Y√™u c·∫ßu tham gia', ()=> requestToJoin(g.id)));
      }
    }
    card.appendChild(actions);
    groupsGrid.appendChild(card);
  });
}

/* ========== Invite friends to group (UI & logic) ========== */
let currentInviteGroupId = null;

function openInviteModal(groupId){
  const me = getCurrentUser(); if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ m·ªùi b·∫°n.');
  currentInviteGroupId = groupId;
  inviteFriendList.innerHTML = '';
  // get user's friends (if stored as array of usernames)
  const myUser = getUsers().find(u=>u.username===me.username) || {friends:[]};
  const friends = Array.isArray(myUser.friends) ? myUser.friends : [];
  if(friends.length === 0){
    inviteFriendList.innerHTML = '<div class="empty">B·∫°n ch∆∞a c√≥ b·∫°n b√® ƒë·ªÉ m·ªùi.</div>';
    inviteModal.style.display = 'flex'; return;
  }
  const g = getGroups().find(x=>x.id===groupId);
  friends.forEach(fn => {
    const u = getUsers().find(uu=>uu.username===fn);
    // skip if already member
    if(g && (g.members||[]).includes(fn)) return;
    const row = el('div','friend-row');
    row.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${(u&&u.avatar)||DEFAULT_AVATAR}" style="width:40px;height:40px;border-radius:8px;object-fit:cover"><div><div class="user-avatar" data-username="${escapeHtml(fn)}">${escapeHtml(fn)}</div><div style="font-size:12px;color:var(--muted)">${(u&&u.email)||''}</div></div></div>`;
    const inviteBtn = btn('M·ªùi', ()=> {
      sendGroupInvite(groupId, fn);
      inviteBtn.textContent = 'ƒê√£ g·ª≠i'; inviteBtn.disabled = true;
    });
    row.appendChild(inviteBtn);
    inviteFriendList.appendChild(row);
  });
  inviteModal.style.display = 'flex';
}

closeInviteModal.addEventListener('click', ()=> inviteModal.style.display = 'none');

function sendGroupInvite(groupId, toUsername){
  const me = getCurrentUser(); if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  // do not send if already invited
  const invites = getGroupInvites();
  if(invites.some(iv=>iv.groupId===groupId && iv.to===toUsername)) return alert('ƒê√£ g·ª≠i l·ªùi m·ªùi ƒë·∫øn ng∆∞·ªùi n√†y.');
  invites.push({ id: 'gi'+Date.now(), groupId, from: me.username, to: toUsername, time: Date.now() });
  saveGroupInvites(invites);
  renderInviteBell();
  alert('ƒê√£ g·ª≠i l·ªùi m·ªùi t·ªõi ' + toUsername);
}

/* Invite bell & panel rendering */
inviteBellWrap.addEventListener('click', (e)=>{
  e.stopPropagation();
  const panel = invitePanel;
  panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
  if(panel.style.display === 'block') renderInvitePanel();
});
// close invite panel on outside click
document.addEventListener('click', ()=>{ invitePanel.style.display = 'none'; });

function renderInviteBell(){
  const me = getCurrentUser(); if(!me){ inviteBadge.style.display='none'; return; }
  const invites = getGroupInvites();
  const incoming = invites.filter(iv=>iv.to === me.username);
  if(incoming.length > 0){
    inviteBadge.style.display = 'inline-block';
    inviteBadge.textContent = incoming.length;
  } else {
    inviteBadge.style.display = 'none';
  }
}

function renderInvitePanel(){
  const me = getCurrentUser(); invitePanel.innerHTML = '';
  if(!me){ invitePanel.innerHTML = '<div style="padding:8px">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem l·ªùi m·ªùi.</div>'; return; }
  const invites = getGroupInvites().filter(iv=>iv.to === me.username);
  if(invites.length === 0){ invitePanel.innerHTML = '<div style="padding:8px">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</div>'; return; }
  invites.forEach(iv=>{
    const g = getGroups().find(gg=>gg.id === iv.groupId) || {};
    const item = el('div','invite-item');
    item.innerHTML = `<div><div style="font-weight:600">${escapeHtml(g.name||'Nh√≥m (ƒë√£ x√≥a)')}</div><div class="meta">T·ª´: ${escapeHtml(iv.from)} ‚Ä¢ ${new Date(iv.time).toLocaleString()}</div></div>`;
    const actions = el('div'); 
    const accept = btn('Ch·∫•p nh·∫≠n', ()=> { acceptGroupInvite(iv.id); });
    const decline = btn('T·ª´ ch·ªëi', ()=> { declineGroupInvite(iv.id); }, 'ghost');
    actions.appendChild(accept); actions.appendChild(decline);
    item.appendChild(actions);
    invitePanel.appendChild(item);
  });
}

/* Accept / decline invite */
function acceptGroupInvite(invId){
  const invites = getGroupInvites(); const inv = invites.find(x=>x.id===invId); if(!inv) return;
  const me = getCurrentUser(); if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  const gs = getGroups(); const g = gs.find(x=>x.id===inv.groupId); if(!g) { alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.'); // remove invite
    saveGroupInvites(invites.filter(x=>x.id!==invId)); renderInviteBell(); renderInvitePanel(); return;
  }
  if(!g.members) g.members = [];
  if(!g.members.includes(me.username)) g.members.push(me.username);
  saveGroups(gs);
  // remove invite
  saveGroupInvites(invites.filter(x=>x.id!==invId));
  alert('B·∫°n ƒë√£ tham gia nh√≥m "'+g.name+'".');
  renderAll();
  renderInviteBell();
  renderInvitePanel();
}

function declineGroupInvite(invId){
  const invites = getGroupInvites(); if(!invites.some(x=>x.id===invId)) return;
  saveGroupInvites(invites.filter(x=>x.id!==invId));
  renderInviteBell(); renderInvitePanel();
  alert('ƒê√£ t·ª´ ch·ªëi l·ªùi m·ªùi.');
}

/* ========== Group utilities (existing code kept) ========== */
/* ... existing functions below are unchanged, copied from your original file ... */

/* For brevity I will reuse the exact original functions for viewGroup, create, join requests, leave, confirm delete, chat, etc. */
/* (The rest of the file remains identical to your original code except added invite logic and avatar click behavior.) */

/* ------ existing implementations pasted below ------ */

function viewGroup(groupId){
  const g = getGroups().find(x=>x.id===groupId);
  if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  const me = getCurrentUser();
  if(me && (g.members||[]).includes(me.username)){
    openChat(groupId);
  } else {
    let info = `Nh√≥m: ${g.name}\nCh·ªß: ${g.owner}\nTh√†nh vi√™n: ${(g.members||[]).length}\n\n${g.desc||''}`;
    if(me){
      if(confirm(info + '\n\nB·∫°n c√≥ mu·ªën g·ª≠i y√™u c·∫ßu tham gia?')) requestToJoin(groupId);
    } else {
      alert(info + '\n\nB·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i y√™u c·∫ßu tham gia.');
    }
  }
}

btnCreate.addEventListener('click', ()=>{
  if(!getCurrentUser()){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o nh√≥m!'); return; }
  inputGroupName.value=''; inputGroupDesc.value='';
  modalCreate.style.display = 'flex';
});
cancelCreate.addEventListener('click', ()=> modalCreate.style.display = 'none');
confirmCreate.addEventListener('click', ()=>{
  const me = getCurrentUser(); if(!me){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p'); modalCreate.style.display='none'; return; }
  const name = inputGroupName.value.trim(); const desc = inputGroupDesc.value.trim();
  if(!name) return alert('Vui l√≤ng nh·∫≠p t√™n nh√≥m');
  const gs = getGroups();
  if(gs.some(x=>x.name.toLowerCase() === name.toLowerCase())) return alert('T√™n nh√≥m ƒë√£ t·ªìn t·∫°i');
  const id = uid(); gs.unshift({ id, name, desc, owner: me.username, members: [me.username], createdAt: Date.now() });
  saveGroups(gs); modalCreate.style.display='none'; renderAll(); openChat(id);
});

function requestToJoin(groupId){
  const me = getCurrentUser(); if(!me){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p'); return; }
  const reqs = getJoinRequests(); if(reqs.some(r=>r.groupId===groupId && r.from===me.username)) return alert('B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu r·ªìi.');
  reqs.push({ id: 'r'+Date.now(), groupId, from: me.username, time: Date.now() }); saveJoinRequests(reqs);
  alert('ƒê√£ g·ª≠i y√™u c·∫ßu tham gia. Ch·ªß nh√≥m s·∫Ω duy·ªát.'); renderAll();
}

function manageJoinRequests(groupId){
  const me = getCurrentUser(); if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  const g = getGroups().find(x=>x.id===groupId); if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  if(g.owner !== me.username) return alert('Ch·ªâ ch·ªß nh√≥m m·ªõi c√≥ quy·ªÅn duy·ªát.');
  const reqs = getJoinRequests().filter(r=>r.groupId===groupId);
  if(!reqs.length) return alert('Kh√¥ng c√≥ y√™u c·∫ßu n√†o.');
  let message = 'Y√™u c·∫ßu tham gia:\n'; reqs.forEach((r,i)=> message += `${i+1}. ${r.from}\n`);
  const inp = prompt(message + '\nNh·∫≠p s·ªë th·ª© t·ª± ƒë·ªÉ duy·ªát (v√≠ d·ª• 1) ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ h·ªßy:');
  if(!inp) return;
  const idx = parseInt(inp) - 1; if(isNaN(idx) || idx < 0 || idx >= reqs.length) return alert('L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá.');
  const chosen = reqs[idx];
  if(!confirm(`B·∫°n c√≥ ch·∫•p nh·∫≠n ${chosen.from} v√†o nh√≥m "${g.name}"?`)){
    saveJoinRequests(getJoinRequests().filter(r=>r.id !== chosen.id)); renderAll(); return alert('ƒê√£ t·ª´ ch·ªëi.');
  }
  let gs = getGroups(); const gg = gs.find(x=>x.id===groupId); if(!gg.members) gg.members = [];
  if(!gg.members.includes(chosen.from)) gg.members.push(chosen.from);
  saveGroups(gs); saveJoinRequests(getJoinRequests().filter(r=>r.id !== chosen.id)); alert('ƒê√£ ch·∫•p nh·∫≠n.'); renderAll();
}

function leaveGroup(groupId){
  const me = getCurrentUser(); if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  let gs = getGroups(); const g = gs.find(x=>x.id===groupId); if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  if(g.owner === me.username) return alert('Ch·ªß nh√≥m kh√¥ng th·ªÉ r·ªùi. X√≥a nh√≥m n·∫øu mu·ªën.');
  g.members = (g.members||[]).filter(m=>m!==me.username); saveGroups(gs); renderAll();
}

let activeConfirmCallback = null;
function confirmDeleteGroup(groupId){
  const me = getCurrentUser(); const g = getGroups().find(x=>x.id===groupId);
  if(!g || g.owner !== me.username) return alert('B·∫°n kh√¥ng c√≥ quy·ªÅn.');
  activeConfirmCallback = ()=> {
    let gs = getGroups().filter(x=>x.id !== groupId); saveGroups(gs);
    const chats = getChats(); if(chats[groupId]){ delete chats[groupId]; saveChats(chats); }
    saveJoinRequests(getJoinRequests().filter(r=>r.groupId !== groupId));
    saveGroupInvites(getGroupInvites().filter(iv=>iv.groupId !== groupId));
    modalConfirm.style.display='none'; renderAll(); if(openChatGroupId === groupId) closeChatWindow();
  };
  confirmTitle.textContent = 'X√≥a nh√≥m'; confirmMsg.textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m "${g.name}"?`; modalConfirm.style.display='flex';
}

confirmCancel.addEventListener('click', ()=> { modalConfirm.style.display='none'; activeConfirmCallback = null; });
confirmOk.addEventListener('click', ()=> { modalConfirm.style.display='none'; if(typeof activeConfirmCallback==='function') activeConfirmCallback(); activeConfirmCallback = null; });

/* Chat (copied original) */
let openChatGroupId = null;
function openChat(groupId){
  const me = getCurrentUser(); if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ chat.');
  const g = getGroups().find(x=>x.id===groupId); if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  if(!(g.members||[]).includes(me.username)) return alert('B·∫°n ph·∫£i l√† th√†nh vi√™n ƒë·ªÉ chat trong nh√≥m n√†y.');
  openChatGroupId = groupId;
  chatTitle.textContent = g.name; chatMeta.textContent = `${(g.members||[]).length} th√†nh vi√™n ‚Ä¢ Ch·ªß: ${g.owner}`;
  chatAvatar.src = (getUsers().find(u=>u.username===g.owner)?.avatar) || DEFAULT_AVATAR;
  chatWindow.style.display = 'flex';
  renderChat();
}
function closeChatWindow(){ chatWindow.style.display='none'; openChatGroupId = null; chatBody.innerHTML=''; }
closeChat.addEventListener('click', ()=> closeChatWindow());

function renderChat(){
  if(!openChatGroupId) return;
  const chats = getChats(); const msgs = chats[openChatGroupId] || [];
  chatBody.innerHTML = '';
  const me = getCurrentUser();
  msgs.forEach((m, idx) => {
    const row = el('div','msg' + ((m.from === (me && me.username)) ? ' me' : ''));
    const avatarEl = el('img','avatar-sm'); avatarEl.src = (getUsers().find(u=>u.username===m.from)?.avatar) || DEFAULT_AVATAR;
    avatarEl.title = m.from;
    avatarEl.setAttribute('data-username', m.from);
    avatarEl.addEventListener('click', ()=> showUserPopup(m.from));

    const bubble = el('div','bubble' + ((m.from === (me && me.username)) ? ' me' : ''));
    const headerHtml = `<div style="font-size:13px;margin-bottom:6px"><strong>${escapeHtml(m.from)}</strong> <span style="font-size:11px;color:var(--muted);margin-left:8px">${escapeHtml(m.time)}</span></div>`;
    bubble.innerHTML = headerHtml + `<div>${escapeHtml(m.text||'')}</div>`;

    if(m.image){
      bubble.innerHTML += `<div><img src="${m.image}" alt="image" style="max-width:260px;border-radius:8px;margin-top:8px"></div>`;
    }
    if(m.fileData){
      const type = m.fileType || '';
      const name = m.fileName || 'file';
      const sizeKB = m.fileSize ? (m.fileSize/1024).toFixed(1) + ' KB' : '';
      if(type.startsWith('image/')){
        bubble.innerHTML += `<div><img src="${m.fileData}" alt="${escapeHtml(name)}" style="max-width:260px;border-radius:8px;margin-top:8px"></div>`;
      } else if(type.startsWith('video/')){
        bubble.innerHTML += `<div style="margin-top:8px"><video controls style="max-width:320px;border-radius:8px"><source src="${m.fileData}" type="${escapeHtml(type)}">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video</video></div>`;
      } else {
        bubble.innerHTML += `
          <div class="file-card" style="margin-top:8px">
            <div class="file-row">
              <div style="font-size:20px">üìé</div>
              <div style="display:flex;flex-direction:column">
                <div style="font-weight:600">${escapeHtml(name)}</div>
                <div style="font-size:12px;color:var(--muted)">${sizeKB}</div>
              </div>
            </div>
            <a href="${m.fileData}" download="${escapeHtml(name)}" style="margin-top:6px;padding:6px 8px;border-radius:8px;background:var(--accent);color:#fff;text-decoration:none;font-size:13px">‚¨áÔ∏è T·∫£i xu·ªëng</a>
          </div>`;
      }
    }

    const g = getGroups().find(x=>x.id===openChatGroupId);
    if(me && (m.from === me.username || (g && g.owner === me.username))){
      const delBtn = el('button','small ghost'); delBtn.textContent = '‚úñ'; delBtn.style.marginLeft = '8px';
      delBtn.addEventListener('click', ()=>{
        if(!confirm('X√≥a tin nh·∫Øn n√†y?')) return;
        const all = getChats(); all[openChatGroupId] = all[openChatGroupId].filter((_,i)=>i!==idx); saveChats(all); renderChat();
      });
      bubble.appendChild(delBtn);
    }

    if(m.from === (me && me.username)){
      row.appendChild(bubble); row.appendChild(avatarEl); row.classList.add('me');
    } else {
      row.appendChild(avatarEl); row.appendChild(bubble);
    }
    chatBody.appendChild(row);
  });
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* send text message */
chatSend.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); } });
function sendChat(){
  const text = chatInput.value.trim();
  if(!text) return;
  if(!openChatGroupId) return alert('M·ªü chat nh√≥m tr∆∞·ªõc khi g·ª≠i tin nh·∫Øn.');
  const me = getCurrentUser(); if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  const chats = getChats(); if(!chats[openChatGroupId]) chats[openChatGroupId] = [];
  chats[openChatGroupId].push({ from: me.username, text, time: timeNow() });
  saveChats(chats); chatInput.value=''; renderChat();
}

/* send files: multiple -> each file is a message */
chatFileInput.addEventListener('change', (e)=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;
  const me = getCurrentUser(); if(!me){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.'); chatFileInput.value=''; return; }
  if(!openChatGroupId){ alert('M·ªü chat nh√≥m tr∆∞·ªõc khi g·ª≠i file.'); chatFileInput.value=''; return; }
  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = ev => {
      const data = ev.target.result;
      const chats = getChats(); if(!chats[openChatGroupId]) chats[openChatGroupId] = [];
      chats[openChatGroupId].push({
        from: me.username, text: '', fileName: file.name, fileType: file.type || '', fileSize: file.size || 0, fileData: data, time: timeNow()
      });
      saveChats(chats); renderChat();
    };
    reader.readAsDataURL(file);
  });
  chatFileInput.value = '';
});

/* ========== Search groups ========== */
searchBtn.addEventListener('click', ()=> {
  const q = (searchInput.value||'').trim().toLowerCase();
  if(!q) return alert('Nh·∫≠p t·ª´ kh√≥a t√¨m nh√≥m.');
  const gs = getGroups();
  const matched = gs.filter(g=> g.name.toLowerCase().includes(q) || (g.desc||'').toLowerCase().includes(q));
  if(matched.length === 0){
    groupsGrid.innerHTML = '<div class="empty">Kh√¥ng t√¨m th·∫•y nh√≥m ph√π h·ª£p.</div>';
    noGroups.style.display = 'none';
  } else {
    renderGroups(matched);
  }
  clearSearch.style.display = 'inline-block';
});
clearSearch.addEventListener('click', ()=> { searchInput.value=''; renderAll(); clearSearch.style.display='none'; });
searchInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') searchBtn.click(); });

/* storage helpers (chats & requests) */
function getChats(){ return JSON.parse(localStorage.getItem('groupChats')||'{}'); }
function saveChats(obj){ localStorage.setItem('groupChats', JSON.stringify(obj)); }

/* ========== Combined render & init ========= */
function renderAll(){ renderSuggested(); renderGroups(); renderInviteBell(); }
if(!localStorage.getItem('groups')) saveGroups([]);
if(!localStorage.getItem('groupChats')) saveChats({});
if(!localStorage.getItem('groupJoinRequests')) saveJoinRequests([]);
if(!localStorage.getItem('groupInvites')) saveGroupInvites([]);
renderAll();

/* modal close on backdrop click */
document.querySelectorAll('.backdrop').forEach(b=>{
  b.addEventListener('click', e=>{
    if(e.target === b) b.style.display = 'none';
  });
});

/* clicking on username/avatars to show small info (delegate) */
document.addEventListener('click', function(e){
  const target = e.target.closest && e.target.closest('.user-avatar');
  if(target){
    const uname = target.getAttribute('data-username');
    if(uname) showUserPopup(uname);
  }
});

/* debug helpers */
window._renderGroups = renderAll;
window._getGroups = getGroups;
window._getChats = getChats;

/* ========== Remaining original functions referenced earlier (showUserPopup, etc.) ====== */
/* Reusing your original showUserPopup implementation so behavior matches previous file */

function showUserPopup(username){
  const user = getUsers().find(u=>u.username===username);
  if(!user) return alert("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.");
  const me = getCurrentUser();
  const box = document.createElement("div");
  box.style.position="fixed";
  box.style.inset="0";
  box.style.background="rgba(0,0,0,0.5)";
  box.style.display="flex";
  box.style.alignItems="center";
  box.style.justifyContent="center";
  box.innerHTML=`
    <div style="background:white;border-radius:12px;padding:20px;width:300px;box-shadow:0 6px 20px rgba(0,0,0,0.3);text-align:center;">
      <img src="${user.avatar||DEFAULT_AVATAR}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">
      <h3>${user.username}</h3>
      <p style="font-size:14px;color:#555;">ID: ${user.id||'(·∫®n)'}</p>
      <p style="font-size:13px;color:#777;">${user.desc||'Kh√¥ng c√≥ m√¥ t·∫£.'}</p>
      ${me && me.username!==user.username ? `<button id="inviteBtn" style="padding:8px 12px;border:0;background:#0072ff;color:#fff;border-radius:8px;cursor:pointer;">G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n</button>`:''}
      <div style="margin-top:10px;"><button id="closePopup" style="border:0;background:#ccc;border-radius:6px;padding:6px 12px;cursor:pointer;">ƒê√≥ng</button></div>
    </div>`;
  document.body.appendChild(box);

  box.querySelector("#closePopup").onclick=()=>box.remove();

  const btn=box.querySelector("#inviteBtn");
  if(btn){
    btn.onclick=()=>{
      const invites=getGroupInvites(); // reuse groupInvites key? For friend invites we might use general invites; to avoid collision, we just simulate friend invite -> use groupJoinRequests? 
      // Simpler: add friend request to invites stored under 'friendRequests' (not present). We'll reuse groupInvites but with groupId=null to indicate friend request.
      const meNow = getCurrentUser();
      if(!meNow) { alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i l·ªùi m·ªùi."); return; }
      if(invites.some(i=>i.to===user.username && i.from===meNow.username && !i.groupId)){
        alert("B·∫°n ƒë√£ g·ª≠i l·ªùi m·ªùi r·ªìi!");return;
      }
      invites.push({to:user.username,from:meNow.username,fromId:meNow.id,fromAvatar:meNow.avatar||DEFAULT_AVATAR, groupId: null});
      saveGroupInvites(invites);
      alert("ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!");
      box.remove();
    };
  }
}

</script>
</body>
</html>
