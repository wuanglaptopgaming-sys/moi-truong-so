<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nh√≥m h·ªçc t·∫≠p ‚Äî Groups</title>
  <style>
    :root{
      --bg:#f5f8ff; --card:#fff; --accent:#0072ff; --muted:#6b7280;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#111}
    header{background:var(--card);padding:12px 20px;border-bottom:1px solid #e6eef8;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#00c6ff,#0072ff);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    nav a{margin-left:12px;text-decoration:none;color:#111;font-weight:600}
    .container{max-width:1200px;margin:28px auto;padding:0 16px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px;flex-wrap:wrap}
    .title{font-size:20px;font-weight:700}
    .btn{background:var(--accent);color:#fff;border:0;padding:9px 14px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,114,255,.12)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);display:flex;flex-direction:column;justify-content:space-between;min-height:120px}
    .meta{font-size:13px;color:var(--muted);margin-top:8px}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .small{font-size:13px;padding:6px 8px;border-radius:8px;border:0;cursor:pointer}
    .small.warn{background:#ef4444;color:#fff}
    .small.ghost{background:transparent;border:1px solid #e6eef8}
    .empty{color:var(--muted);padding:18px;background:#fff;border-radius:10px;text-align:center;box-shadow:0 6px 18px rgba(2,6,23,0.03)}
    /* modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:80}
    .modal{background:var(--card);padding:18px;border-radius:12px;max-width:720px;width:92%;max-height:90vh;overflow:auto}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eaf5;margin-top:6px}
    textarea{min-height:90px}
    /* chat */
    .chat-window{position:fixed;right:18px;bottom:18px;width:520px;height:640px;background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.18);display:flex;flex-direction:column;overflow:hidden;z-index:99}
    .chat-header{padding:12px;background:linear-gradient(90deg,#0ea5ff,#0066ff);color:#fff;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .chat-body{flex:1;padding:12px;overflow:auto;background:#f5f7fb}
    .msg{margin-bottom:12px;display:flex;gap:8px;align-items:flex-end}
    .msg.me{justify-content:flex-end}
    .avatar-sm{width:36px;height:36px;border-radius:50%;object-fit:cover}
    .bubble{max-width:72%;padding:8px 12px;border-radius:12px;background:#fff;box-shadow:0 4px 10px rgba(2,6,23,0.04)}
    .bubble.me{background:#d7f3ff}
    .bubble img{max-width:200px;border-radius:8px;display:block;margin-top:6px}
    .chat-input{display:flex;padding:8px;border-top:1px solid #eee;gap:8px;align-items:center}
    .chat-input input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8}
    .chat-input button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff}
    .chat-controls{display:flex;gap:8px;align-items:center}
    .searchWrap{display:flex;gap:8px;align-items:center}
    @media(max-width:820px){.chat-window{width:94%;right:3%;bottom:8px;height:60vh}}
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ED</div>
    <div>
      <div style="font-weight:700">Nh√≥m h·ªçc t·∫≠p</div>
      <div style="font-size:12px;color:var(--muted)">T·∫°o, y√™u c·∫ßu tham gia, qu·∫£n l√Ω v√† tr√≤ chuy·ªán</div>
    </div>
  </div>
  <nav>
    <a href="index.html">Trang ch·ªß</a>
    <a href="community.html" style="margin-left:12px">C·ªông ƒë·ªìng</a>
  </nav>
</header>

<main class="container">
  <div class="toolbar">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div class="title">Qu·∫£n l√Ω nh√≥m</div>
      <div style="color:var(--muted);font-size:13px">Ch·ªâ ng∆∞·ªùi ƒë√£ ƒëƒÉng nh·∫≠p m·ªõi c√≥ th·ªÉ t·∫°o / y√™u c·∫ßu tham gia / tr√≤ chuy·ªán</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div class="searchWrap">
        <input id="searchInput" placeholder="T√¨m nh√≥m (ghi 1 ph·∫ßn t√™n c≈©ng ƒë∆∞·ª£c)" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
        <button id="searchBtn" class="small ghost">T√¨m</button>
        <button id="clearSearch" class="small ghost" style="display:none">H·ªßy t√¨m</button>
      </div>
      <button id="btnCreate" class="btn">T·∫°o nh√≥m m·ªõi</button>
    </div>
  </div>

  <!-- Suggested area: will show top 3 groups by member count -->
  <section style="margin-bottom:18px">
    <h3 style="margin-bottom:10px">G·ª£i √Ω nh√≥m n·ªïi b·∫≠t</h3>
    <div id="suggestedArea" class="grid"></div>
    <div id="suggestEmpty" class="empty" style="display:none;margin-top:12px">Ch∆∞a c√≥ nh√≥m ƒë·ªÉ g·ª£i √Ω.</div>
  </section>

  <!-- All groups -->
  <section>
    <h3 style="margin-bottom:10px">Nh√≥m </h3>
    <div id="groupsGrid" class="grid"></div>
    <div id="noGroups" class="empty" style="margin-top:12px;display:none">Ch∆∞a c√≥ nh√≥m n√†o ‚Äî h√£y t·∫°o nh√≥m ƒë·∫ßu ti√™n!</div>
  </section>
</main>

<!-- Modal create -->
<div id="modalCreate" class="backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>T·∫°o nh√≥m m·ªõi</h3>
    <label>T√™n nh√≥m</label>
    <input id="inputGroupName" placeholder="V√≠ d·ª•: Nh√≥m L·∫≠p tr√¨nh JS">
    <label>M√¥ t·∫£</label>
    <textarea id="inputGroupDesc" placeholder="M·ª•c ti√™u, n·ªôi quy ng·∫Øn..."></textarea>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="cancelCreate" class="small ghost">H·ªßy</button>
      <button id="confirmCreate" class="small" style="background:var(--accent);color:#fff">T·∫°o</button>
    </div>
  </div>
</div>

<!-- Modal confirm -->
<div id="modalConfirm" class="backdrop">
  <div class="modal">
    <h3 id="confirmTitle">X√°c nh·∫≠n</h3>
    <p id="confirmMsg">B·∫°n c√≥ ch·∫Øc?</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="small">H·ªßy</button>
      <button id="confirmOk" class="small warn">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>

<!-- Chat window -->
<div id="chatWindow" class="chat-window" style="display:none" role="dialog" aria-modal="true">
  <div class="chat-header">
    <div style="display:flex;gap:8px;align-items:center">
      <img id="chatAvatar" src="" class="avatar-sm" style="width:40px;height:40px;border-radius:8px">
      <div>
        <div id="chatTitle" style="font-weight:700"></div>
        <div id="chatMeta" style="font-size:12px;opacity:0.9"></div>
      </div>
    </div>
    <div class="chat-controls">
      <label style="cursor:pointer">üì∑<input id="chatImageInput" type="file" accept="image/*" style="display:none"></label>
      <button id="closeChat" class="small ghost">ƒê√≥ng</button>
    </div>
  </div>
  <div id="chatBody" class="chat-body"></div>
  <div class="chat-input">
    <input id="chatInput" placeholder="G·ª≠i tin nh·∫Øn...">
    <button id="chatSend">G·ª≠i</button>
  </div>
</div>

<script>
/* ---------- Helpers & storage ---------- */
const DEFAULT_AVATAR = 'https://i.imgur.com/PHv4T6B.png';
const uid = ()=> 'g' + Date.now().toString(36).slice(2,10);

function getUsers(){ return JSON.parse(localStorage.getItem('users')||'[]'); }
function getCurrentUser(){ const u = localStorage.getItem('username'); if(!u) return null; return getUsers().find(x=>x.username===u) || null; }
function getGroups(){ return JSON.parse(localStorage.getItem('groups')||'[]'); }
function saveGroups(gs){ localStorage.setItem('groups', JSON.stringify(gs)); }
function getChats(){ return JSON.parse(localStorage.getItem('groupChats')||'{}'); }
function saveChats(c){ localStorage.setItem('groupChats', JSON.stringify(c)); }
function getJoinRequests(){ return JSON.parse(localStorage.getItem('groupJoinRequests')||'[]'); }
function saveJoinRequests(r){ localStorage.setItem('groupJoinRequests', JSON.stringify(r)); }
function timeNow(){ return new Date().toLocaleString('vi-VN',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',year:'numeric'}); }

/* ---------- Elements ---------- */
const suggestedArea = document.getElementById('suggestedArea');
const suggestEmpty = document.getElementById('suggestEmpty');
const groupsGrid = document.getElementById('groupsGrid');
const noGroups = document.getElementById('noGroups');
const modalCreate = document.getElementById('modalCreate');
const btnCreate = document.getElementById('btnCreate');
const inputGroupName = document.getElementById('inputGroupName');
const inputGroupDesc = document.getElementById('inputGroupDesc');
const cancelCreate = document.getElementById('cancelCreate');
const confirmCreate = document.getElementById('confirmCreate');
const modalConfirm = document.getElementById('modalConfirm');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMsg = document.getElementById('confirmMsg');
const confirmOk = document.getElementById('confirmOk');
const confirmCancel = document.getElementById('confirmCancel');

const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearch = document.getElementById('clearSearch');

const chatWindow = document.getElementById('chatWindow');
const chatTitle = document.getElementById('chatTitle');
const chatMeta = document.getElementById('chatMeta');
const chatAvatar = document.getElementById('chatAvatar');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const closeChat = document.getElementById('closeChat');
const chatImageInput = document.getElementById('chatImageInput');

/* ---------- State ---------- */
let groups = getGroups();
let activeConfirmCb = null;
let openChatGroupId = null;

/* ---------- Util ---------- */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }

/* ---------- Render suggested top-3 by members ---------- */
function renderSuggested(){
  const gs = getGroups();
  if(!gs.length){ suggestedArea.innerHTML=''; suggestEmpty.style.display='block'; return; }
  suggestEmpty.style.display='none';
  const sorted = [...gs].sort((a,b)=>(b.members?.length||0)-(a.members?.length||0)).slice(0,3);
  suggestedArea.innerHTML='';
  sorted.forEach(g=>{
    const card = el('div','card');
    card.innerHTML = `<div><h4 style="margin:0">${escapeHtml(g.name)}</h4><div class="meta">Ch·ªß: <strong>${escapeHtml(g.owner)}</strong> ‚Ä¢ ${g.members?g.members.length:0} th√†nh vi√™n</div><p style="margin-top:8px;color:var(--muted)">${escapeHtml(g.desc||'Kh√¥ng c√≥ m√¥ t·∫£')}</p></div>`;
    const actions = el('div','actions');
    actions.appendChild(makeActionButton('Xem',()=> viewGroup(g.id)));
    suggestedArea.appendChild(card);
    card.appendChild(actions);
  });
}

/* ---------- Render all groups (or filtered) ---------- */
function renderGroups(filtered=null){
  groups = getGroups();
  const list = filtered || groups;
  groupsGrid.innerHTML='';
  if(!list.length){ noGroups.style.display='block'; return; } else noGroups.style.display='none';
  const me = getCurrentUser();
  list.forEach(g=>{
    const card = el('div','card');
    const memberCount = (g.members && g.members.length) || 0;
    const owner = g.owner || '(·∫®n)';
    const amOwner = me && me.username === g.owner;
    const isMember = me && g.members && g.members.includes(me.username);
    const pending = me && getJoinRequests().some(r=>r.groupId===g.id && r.from===me.username);
    card.innerHTML = `
      <div>
        <h3 style="margin:0">${escapeHtml(g.name)}</h3>
        <div class="meta">Ch·ªß: <strong>${escapeHtml(owner)}</strong> ‚Ä¢ Th√†nh vi√™n: ${memberCount}</div>
        <p style="margin-top:8px;color:var(--muted)">${escapeHtml(g.desc||'Kh√¥ng c√≥ m√¥ t·∫£')}</p>
      </div>
      <div class="actions"></div>
    `;
    const actions = card.querySelector('.actions');

    // action buttons based on role & status
    if(!me){
      actions.appendChild(makeActionButton('ƒêƒÉng nh·∫≠p ƒë·ªÉ tham gia', ()=> alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông n√†y.'),'ghost'));
    } else {
      if(amOwner){
        actions.appendChild(makeActionButton('Duy·ªát y√™u c·∫ßu', ()=> manageJoinRequests(g.id)));
        actions.appendChild(makeActionButton('Tr√≤ chuy·ªán', ()=> openChat(g.id)));
        actions.appendChild(makeActionButton('X√≥a nh√≥m', ()=> confirmDeleteGroup(g.id),'warn'));
      } else {
        if(isMember){
          actions.appendChild(makeActionButton('R·ªùi nh√≥m', ()=> leaveGroup(g.id),'ghost'));
          actions.appendChild(makeActionButton('Tr√≤ chuy·ªán', ()=> openChat(g.id)));
        } else {
          if(pending){
            actions.appendChild(makeActionButton('ƒê√£ y√™u c·∫ßu', ()=> alert('B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu tham gia. Ch·ªù ch·ªß nh√≥m duy·ªát.'),'ghost'));
          } else {
            actions.appendChild(makeActionButton('Y√™u c·∫ßu tham gia', ()=> requestToJoin(g.id)));
          }
        }
      }
    }

    groupsGrid.appendChild(card);
  });
}

function makeActionButton(text, cb, kind){
  const b = el('button','small');
  if(kind==='warn'){ b.classList.add('warn'); }
  if(kind==='ghost'){ b.classList.add('ghost'); }
  b.textContent = text;
  b.addEventListener('click', cb);
  return b;
}

/* ---------- Group actions ---------- */
btnCreate.addEventListener('click', ()=>{
  if(!getCurrentUser()){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o nh√≥m!'); return; }
  inputGroupName.value=''; inputGroupDesc.value='';
  modalCreate.style.display='flex';
});
cancelCreate.addEventListener('click', ()=> modalCreate.style.display='none');

confirmCreate.addEventListener('click', ()=>{
  const name = inputGroupName.value.trim();
  const desc = inputGroupDesc.value.trim();
  const me = getCurrentUser();
  if(!me){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p!'); modalCreate.style.display='none'; return; }
  if(!name) { alert('Nh·∫≠p t√™n nh√≥m'); return; }
  // ensure no duplicate name (case-insensitive)
  const gs = getGroups();
  if(gs.some(g=>g.name.toLowerCase()===name.toLowerCase())){ alert('T√™n nh√≥m ƒë√£ t·ªìn t·∫°i'); return; }
  const id = uid();
  const g = { id, name, desc, owner: me.username, members: [me.username], createdAt: Date.now() };
  gs.unshift(g);
  saveGroups(gs);
  modalCreate.style.display='none';
  renderAll();
  // open chat
  openChat(id);
});

/* request join */
function requestToJoin(groupId){
  const me = getCurrentUser();
  if(!me){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p'); return; }
  const gs = getGroups();
  const g = gs.find(x=>x.id===groupId);
  if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i');
  // push request
  const reqs = getJoinRequests();
  if(reqs.some(r=>r.groupId===groupId && r.from===me.username)) return alert('B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu tham gia r·ªìi.');
  reqs.push({ id: 'r'+Date.now(), groupId, from: me.username, time: Date.now() });
  saveJoinRequests(reqs);
  alert('ƒê√£ g·ª≠i y√™u c·∫ßu tham gia. Ch·ªß nh√≥m s·∫Ω duy·ªát.');
  renderAll();
}

/* owner manage requests */
function manageJoinRequests(groupId){
  const me = getCurrentUser();
  if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  const g = getGroups().find(x=>x.id===groupId);
  if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  if(g.owner !== me.username) return alert('Ch·ªâ ch·ªß nh√≥m m·ªõi c√≥ quy·ªÅn duy·ªát y√™u c·∫ßu.');
  const reqs = getJoinRequests().filter(r=>r.groupId===groupId);
  if(!reqs.length) return alert('Kh√¥ng c√≥ y√™u c·∫ßu n√†o.');
  // show simple prompt listing
  let list = 'Y√™u c·∫ßu tham gia:\n';
  reqs.forEach((r,i)=> list += `${i+1}. ${r.from}\n`);
  const sel = prompt(list + '\nNh·∫≠p s·ªë th·ª© t·ª± ƒë·ªÉ duy·ªát (ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ h·ªßy):');
  if(!sel) return;
  const idx = parseInt(sel) - 1;
  if(isNaN(idx) || idx < 0 || idx >= reqs.length) return alert('L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá.');
  const chosen = reqs[idx];
  const ok = confirm(`B·∫°n mu·ªën ch·∫•p nh·∫≠n ${chosen.from} v√†o nh√≥m "${g.name}"? (OK = ch·∫•p nh·∫≠n, Cancel = t·ª´ ch·ªëi)`);
  let all = getJoinRequests();
  const removeIndex = all.findIndex(x=>x.id===chosen.id);
  if(removeIndex > -1) all.splice(removeIndex,1);
  saveJoinRequests(all);
  if(ok){
    // add to members
    const gs = getGroups();
    const gg = gs.find(x=>x.id===groupId);
    if(!gg.members) gg.members = [];
    if(!gg.members.includes(chosen.from)) gg.members.push(chosen.from);
    saveGroups(gs);
    alert('ƒê√£ th√™m th√†nh vi√™n.');
  } else {
    alert('ƒê√£ t·ª´ ch·ªëi.');
  }
  renderAll();
}

/* leave group */
function leaveGroup(groupId){
  const me = getCurrentUser();
  if(!me) return;
  const gs = getGroups();
  const g = gs.find(x=>x.id===groupId);
  if(!g) return;
  if(g.owner === me.username){ return alert('Ch·ªß nh√≥m kh√¥ng th·ªÉ r·ªùi. N·∫øu mu·ªën, x√≥a nh√≥m.'); }
  g.members = (g.members||[]).filter(m=>m!==me.username);
  saveGroups(gs);
  renderAll();
}

/* delete group confirm */
function confirmDeleteGroup(groupId){
  const me = getCurrentUser();
  const g = getGroups().find(x=>x.id===groupId);
  if(!g) return;
  if(!me || me.username !== g.owner) return alert('Ch·ªâ ch·ªß nh√≥m m·ªõi c√≥ quy·ªÅn x√≥a.');
  // confirm modal
  activeConfirmCb = ()=> {
    let gs = getGroups().filter(x=>x.id!==groupId);
    saveGroups(gs);
    const chats = getChats();
    delete chats[groupId];
    saveChats(chats);
    // remove related join requests
    let reqs = getJoinRequests().filter(r=>r.groupId!==groupId);
    saveJoinRequests(reqs);
    hideConfirm();
    renderAll();
    if(openChatGroupId === groupId) closeChatWindow();
  };
  confirmTitle.textContent = 'X√≥a nh√≥m';
  confirmMsg.textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m "${g.name}"?`;
  document.getElementById('modalConfirm').style.display = 'flex';
}

/* confirm modal handlers */
confirmCancel.addEventListener('click', ()=> { document.getElementById('modalConfirm').style.display='none'; activeConfirmCb=null; });
confirmOk.addEventListener('click', ()=> { document.getElementById('modalConfirm').style.display='none'; if(typeof activeConfirmCb==='function') activeConfirmCb(); activeConfirmCb=null; });

function hideConfirm(){ document.getElementById('modalConfirm').style.display='none'; activeConfirmCb=null; }

/* view group (scroll into view or highlight) */
function viewGroup(groupId){
  // simple: open chat if member, else show details in alert
  const g = getGroups().find(x=>x.id===groupId);
  if(!g) return alert('Kh√¥ng t√¨m th·∫•y nh√≥m.');
  const me = getCurrentUser();
  if(me && g.members && g.members.includes(me.username)) return openChat(groupId);
  // else show basic info + option to request to join
  let info = `Nh√≥m: ${g.name}\nCh·ªß: ${g.owner}\nTh√†nh vi√™n: ${(g.members||[]).length}\n\n${g.desc||''}`;
  if(me) {
    const ask = confirm(info + '\n\nB·∫°n c√≥ mu·ªën g·ª≠i y√™u c·∫ßu tham gia?');
    if(ask) requestToJoin(groupId);
  } else {
    alert(info + '\n\nB·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i y√™u c·∫ßu tham gia.');
  }
}

/* ---------- Chat: open, render, send, delete, images ---------- */
function openChat(groupId){
  const me = getCurrentUser();
  if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ chat.');
  const g = getGroups().find(x=>x.id===groupId);
  if(!g) return alert('Nh√≥m kh√¥ng t·ªìn t·∫°i.');
  if(!(g.members && g.members.includes(me.username))) return alert('B·∫°n ph·∫£i l√† th√†nh vi√™n ƒë·ªÉ chat.');
  openChatGroupId = groupId;
  chatTitle.textContent = g.name;
  chatMeta.textContent = `${(g.members||[]).length} th√†nh vi√™n ‚Ä¢ Ch·ªß: ${g.owner}`;
  chatAvatar.src = getUsers().find(u=>u.username===g.owner)?.avatar || DEFAULT_AVATAR;
  document.getElementById('chatWindow').style.display = 'flex';
  renderChat();
}

/* close chat */
closeChat.addEventListener('click', ()=> closeChatWindow());
function closeChatWindow(){ document.getElementById('chatWindow').style.display='none'; openChatGroupId=null; chatBody.innerHTML=''; }

/* render chat messages */
function renderChat(){
  if(!openChatGroupId) return;
  const chats = getChats();
  const msgs = chats[openChatGroupId] || [];
  chatBody.innerHTML = '';
  const me = getCurrentUser();
  msgs.forEach((m, idx) => {
    const row = el('div','msg' + ((m.from === (me && me.username)) ? ' me' : ''));
    // avatar
    const avatarEl = el('img','avatar-sm');
    avatarEl.src = (getUsers().find(u=>u.username===m.from)?.avatar) || DEFAULT_AVATAR;
    avatarEl.style.width = '36px'; avatarEl.style.height='36px'; avatarEl.style.borderRadius='8px';
    // bubble
    const bubble = el('div','bubble' + ((m.from === (me && me.username)) ? ' me' : ''));
    bubble.innerHTML = `<div style="font-size:13px;margin-bottom:6px"><strong>${escapeHtml(m.from)}</strong> <span style="font-size:11px;color:var(--muted);margin-left:8px">${escapeHtml(m.time)}</span></div>`;
    bubble.innerHTML += `<div>${escapeHtml(m.text||'')}</div>`;
    if(m.image){
      bubble.innerHTML += `<div><img src="${m.image}" alt="image"></div>`;
    }
    // delete control (sender or owner)
    if(me && (m.from === me.username || getGroups().find(g=>g.id===openChatGroupId)?.owner === me.username)){
      const delBtn = el('button','small ghost');
      delBtn.textContent = '‚úñ';
      delBtn.style.marginLeft = '8px';
      delBtn.addEventListener('click', ()=> {
        if(!confirm('X√≥a tin nh·∫Øn n√†y?')) return;
        const chatsAll = getChats();
        chatsAll[openChatGroupId] = chatsAll[openChatGroupId].filter((_,i)=>i!==idx);
        saveChats(chatsAll);
        renderChat();
      });
      bubble.appendChild(delBtn);
    }
    // assemble
    if(m.from === (me && me.username)){
      // me: show bubble on right
      row.appendChild(bubble);
      row.appendChild(avatarEl);
      row.style.justifyContent = 'flex-end';
    } else {
      row.appendChild(avatarEl);
      row.appendChild(bubble);
    }
    chatBody.appendChild(row);
  });
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* send chat (text) */
chatSend.addEventListener('click', sendChat);
chatInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendChat(); });
function sendChat(){
  const txt = chatInput.value.trim();
  if(!txt && !chatImagePending) return;
  if(!openChatGroupId) return alert('M·ªü 1 nh√≥m ƒë·ªÉ g·ª≠i tin nh·∫Øn.');
  const me = getCurrentUser();
  if(!me) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
  const chats = getChats();
  if(!chats[openChatGroupId]) chats[openChatGroupId]=[];
  const msg = { from: me.username, text: txt || '', time: timeNow() };
  if(chatImagePending){ msg.image = chatImagePending; chatImagePending = null; }
  chats[openChatGroupId].push(msg);
  saveChats(chats);
  chatInput.value='';
  renderChat();
}

/* send image: handle input file -> dataURL -> attach to next message immediately */
let chatImagePending = null;
chatImageInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const data = ev.target.result;
    // if chat open and user is member, send as message with image
    if(!openChatGroupId) { alert('M·ªü chat nh√≥m tr∆∞·ªõc khi g·ª≠i ·∫£nh.'); chatImageInput.value=''; return; }
    const me = getCurrentUser();
    if(!me) { alert('B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p.'); chatImageInput.value=''; return; }
    const chats = getChats();
    if(!chats[openChatGroupId]) chats[openChatGroupId] = [];
    chats[openChatGroupId].push({ from: me.username, text:'', image: data, time: timeNow() });
    saveChats(chats);
    chatImageInput.value='';
    renderChat();
  };
  reader.readAsDataURL(f);
});

/* ---------- Search groups (partial match) ---------- */
searchBtn.addEventListener('click', ()=> {
  const q = (searchInput.value||'').trim().toLowerCase();
  if(!q) return alert('Nh·∫≠p t·ª´ kh√≥a t√¨m nh√≥m.');
  const gs = getGroups();
  const matched = gs.filter(g=> g.name.toLowerCase().includes(q) || (g.desc||'').toLowerCase().includes(q));
  renderGroups(matched);
  clearSearch.style.display = 'inline-block';
});
clearSearch.addEventListener('click', ()=> {
  searchInput.value='';
  renderAll();
  clearSearch.style.display='none';
});
searchInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') searchBtn.click(); });

/* ---------- Render all combined ---------- */
function renderAll(){
  renderSuggested();
  renderGroups();
}

/* ---------- Init ---------- */
// Ensure groups key exists (we purposely do NOT prefill default groups)
if(!localStorage.getItem('groups')) saveGroups([]);

// ensure join requests present
if(!localStorage.getItem('groupJoinRequests')) saveJoinRequests([]);

// ensure chats object exists
if(!localStorage.getItem('groupChats')) saveChats({});

renderAll();

/* modal close on click outside */
document.querySelectorAll('.backdrop').forEach(b=>{
  b.addEventListener('click', e=>{
    if(e.target === b) b.style.display='none';
  });
});

/* Expose for debug */
window._groups_refresh = renderAll;

</script>
</body>
</html>

